<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة المشرف</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
  <header>
    <h1>📊 لوحة المشرف / مدير المبيعات</h1>
    <nav>
      <button onclick="showSection('delegates')">👥 المندوبين</button>
      <button onclick="showSection('map')">🗺️ الخريطة</button>
      <button onclick="showSection('reports')">📑 التقارير</button>
      <button onclick="showSection('notifications')">🔔 الإشعارات</button>
    </nav>
  </header>

  <!-- قسم المندوبين -->
  <section id="delegates" class="page">
    <h2>متابعة المندوبين</h2>
    <div id="delegateList" class="card-container"></div>
  </section>

  <!-- قسم الخريطة -->
  <section id="map" class="page" style="display:none;">
    <h2>الخريطة</h2>
    <select id="delegateSelect" onchange="filterMap()">
      <option value="all">عرض الجميع</option>
    </select>
    <div id="mapView" style="width:100%;height:400px;background:#eee;text-align:center;line-height:400px;">
      🗺️ خريطة المندوبين
    </div>
  </section>

  <!-- قسم التقارير -->
  <section id="reports" class="page" style="display:none;">
    <h2>التقارير</h2>
    <div id="reportList" class="card-container"></div>
  </section>

  <!-- قسم الإشعارات -->
  <section id="notifications" class="page" style="display:none;">
    <h2>الإشعارات</h2>
    <ul id="notificationsList"></ul>
  </section>

  <script>
    // تبديل الأقسام
    function showSection(id) {
      document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }

    // جلب المندوبين
    async function loadDelegates() {
      const res = await axios.get('/api/users');
      const delegates = res.data.filter(u => u.role === 'delegate');
      const container = document.getElementById('delegateList');
      const select = document.getElementById('delegateSelect');
      container.innerHTML = '';
      delegates.forEach(d => {
        // بطاقة مندوب
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${d.user}</h3>
          <p>📱 ${d.phone}</p>
          <p>الحالة: <span class="status active">نشط</span></p>
          <button onclick="showOnMap('${d.user}')">📍 عرض الموقع</button>
        `;
        container.appendChild(card);

        // إضافة لقائمة الخريطة
        const opt = document.createElement('option');
        opt.value = d.user;
        opt.textContent = d.user;
        select.appendChild(opt);
      });
    }

    // جلب التقارير
    async function loadReports() {
      const res = await axios.get('/api/reports');
      const reports = res.data;
      const container = document.getElementById('reportList');
      container.innerHTML = '';
      reports.forEach(r => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>📝 تقرير ${r.delegate}</h3>
          <p><b>ملاحظات:</b> ${r.notes}</p>
          ${r.images.map(img => `<img src="${img}" style="max-width:100px;">`).join('')}
          ${r.signature ? `<p><b>توقيع:</b><img src="${r.signature}" style="max-width:100px;"></p>` : ''}
          <textarea placeholder="أضف ملاحظات المشرف"></textarea>
          <button>💾 حفظ</button>
        `;
        container.appendChild(card);
      });
    }

    // إشعارات تجريبية
    function loadNotifications() {
      const notifs = [
        "🚨 المندوب أحمد تأخر عن المهمة 20 دقيقة",
        "✅ المندوب سامي أكمل مهمة العميل X"
      ];
      const list = document.getElementById('notificationsList');
      list.innerHTML = '';
      notifs.forEach(n => {
        const li = document.createElement('li');
        li.textContent = n;
        list.appendChild(li);
      });
    }

    // عرض موقع المندوب على الخريطة
    function showOnMap(user) {
      document.getElementById('mapView').innerHTML = `📍 موقع ${user}`;
      showSection('map');
    }

    function filterMap() {
      const sel = document.getElementById('delegateSelect').value;
      document.getElementById('mapView').innerHTML =
        sel === 'all' ? "🗺️ عرض كل المندوبين" : `📍 عرض ${sel}`;
    }

    // تحميل البيانات
    loadDelegates();
    loadReports();
    loadNotifications();
  </script>
</body>
</html>
