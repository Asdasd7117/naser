<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>المشرف</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <h2>📑 مراجعة التقارير</h2>
  <div id="reports"></div>

  <h2>👥 متابعة المندوبين</h2>
  <div id="employeesList"></div>

  <h2>🗺️ خريطة المندوبين - تتبع الوقت الحقيقي</h2>
  <div id="map" style="height:500px;"></div>

  <h2>🔔 إرسال إشعار</h2>
  <form id="notifyForm">
    <select id="notifyEmployee" required>
      <option value="">اختر المندوب</option>
    </select>
    <input type="text" id="notifyTitle" placeholder="عنوان الإشعار" required>
    <input type="text" id="notifyMessage" placeholder="نص الإشعار" required>
    <button type="submit">إرسال</button>
  </form>

  <script>
    let map;
    let markers = {};

    // ===== تحميل التقارير =====
    async function loadReports() {
      const res = await fetch("/reports");
      const reports = await res.json();
      const container = document.getElementById("reports");
      container.innerHTML = "";

      reports.forEach(r => {
        const div = document.createElement("div");
        div.style.border = "1px solid #ccc";
        div.style.padding = "5px";
        div.style.marginBottom = "5px";
        div.innerHTML = `
          <p><strong>مندوب:</strong> ${r.users?.name}</p>
          <p><strong>مهمة:</strong> ${r.tasks?.client_name}</p>
          <p><strong>ملاحظات:</strong> ${r.notes}</p>
          <p><strong>توقيع:</strong> ${r.client_signature || 'غير موجود'}</p>
        `;
        container.appendChild(div);
      });
    }

    // ===== تحميل المندوبين =====
    async function loadEmployees() {
      const res = await fetch("/users");
      const users = await res.json();
      const list = document.getElementById("employeesList");
      const select = document.getElementById("notifyEmployee");
      list.innerHTML = "";
      select.innerHTML = '<option value="">اختر المندوب</option>';

      users.filter(u => u.role === "employee").forEach(u => {
        // عرض حالة المهام
        const div = document.createElement("div");
        div.style.border = "1px solid #ccc";
        div.style.padding = "8px";
        div.style.marginBottom = "5px";
        div.innerHTML = `<strong>${u.name}</strong> | ID: ${u.id} | حالة: ${u.status || 'غير محددة'}`;
        list.appendChild(div);

        // خيار الإشعار
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = u.name;
        select.appendChild(opt);
      });

      return users.filter(u => u.role === "employee");
    }

    // ===== تحميل الخريطة =====
    async function initMap() {
      map = L.map('map').setView([24.7136, 46.6753], 5); // السعودية كمثال
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
    }

    async function updateMap() {
      const employees = await loadEmployees();

      employees.forEach(emp => {
        if(emp.latitude && emp.longitude){
          // تحديث العلامة إذا موجودة
          if(markers[emp.id]) {
            markers[emp.id].setLatLng([emp.latitude, emp.longitude]);
            markers[emp.id].bindPopup(`<strong>${emp.name}</strong><br>حالة: ${emp.status || 'غير محددة'}`);
          } else {
            // إنشاء علامة جديدة
            const marker = L.marker([emp.latitude, emp.longitude]).addTo(map)
              .bindPopup(`<strong>${emp.name}</strong><br>حالة: ${emp.status || 'غير محددة'}`);
            markers[emp.id] = marker;
          }
        }
      });
    }

    // ===== إرسال إشعار =====
    document.getElementById("notifyForm").addEventListener("submit", async e => {
      e.preventDefault();
      const user_id = document.getElementById("notifyEmployee").value;
      const title = document.getElementById("notifyTitle").value;
      const message = document.getElementById("notifyMessage").value;

      const res = await fetch("/notifications", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id, title, message, type: "manual" })
      });

      if(res.ok) alert("✅ تم إرسال الإشعار");
      else alert("❌ خطأ في إرسال الإشعار");
    });

    // ===== التحديث التلقائي =====
    async function refreshData() {
      await loadReports();
      await updateMap();
    }

    async function startAutoRefresh(interval = 10000) {
      await refreshData();
      setInterval(refreshData, interval);
    }

    // ===== بدء الصفحة =====
    (async () => {
      await initMap();
      startAutoRefresh(10000); // تحديث كل 10 ثواني
    })();
  </script>
</body>
</html>
