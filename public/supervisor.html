<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>شاشة المشرف</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:0; }
  h1,h2,h3 { color:#333; text-align:center; margin:10px 0; }
  nav { display:flex; justify-content:center; gap:10px; background:#2196f3; padding:10px; }
  nav button { padding:8px 15px; border:none; border-radius:5px; cursor:pointer; color:white; font-weight:bold; background:#1976d2; }
  section { display:none; padding:15px; margin:10px; border-radius:10px; background:white; }
  section.active { display:block; }
  .card { background:#e3f2fd; padding:10px; border-radius:8px; margin:10px 0; display:flex; justify-content:space-between; align-items:center; }
  .status-active { color:green; font-weight:bold; }
  .status-inactive { color:gray; font-weight:bold; }
  .status-break { color:orange; font-weight:bold; }
  .btn { padding:5px 10px; border:none; border-radius:5px; cursor:pointer; background:#1976d2; color:white; margin-left:5px; }
  .task-count { margin-top:5px; font-size:0.9em; }
  .notif { padding:8px; margin:5px 0; border-radius:5px; background:#ffebee; }
  .notif.unread { background:#f44336; color:white; }
  #map { height:400px; border-radius:8px; margin-top:10px; }
  select { padding:5px; border-radius:5px; border:1px solid #ccc; }
  textarea { width:100%; padding:5px; border-radius:5px; border:1px solid #ccc; margin-top:5px; }
</style>
</head>
<body>
<h1>🧑‍💼 لوحة المشرف / مدير المبيعات</h1>

<nav>
  <button onclick="showTab('supervisorPanel')">📋 متابعة المندوبين</button>
  <button onclick="showTab('mapTab')">🗺️ الخريطة</button>
  <button onclick="showTab('reportsTab')">📝 مراجعة التقارير</button>
  <button onclick="showTab('notificationsTab')">🔔 الإشعارات</button>
</nav>

<!-- متابعة المندوبين -->
<section id="supervisorPanel" class="active">
  <h2>📊 متابعة أداء المندوبين</h2>
  <div id="employeesList"></div>
</section>

<!-- الخريطة -->
<section id="mapTab">
  <h2>🗺️ مواقع المندوبين</h2>
  <label>اختر مندوب:</label>
  <select id="employeeSelectMap">
    <option value="all">الكل</option>
  </select>
  <div id="map"></div>
</section>

<!-- مراجعة التقارير -->
<section id="reportsTab">
  <h2>📝 التقارير المرفوعة</h2>
  <div id="reportsList"></div>
</section>

<!-- الإشعارات -->
<section id="notificationsTab">
  <h2>🔔 الإشعارات</h2>
  <div id="notifications"></div>
</section>

<script>
function showTab(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

// ===== متابعة المندوبين =====
async function loadEmployees(){
  const res = await fetch("/users");
  const users = await res.json();
  const container = document.getElementById("employeesList");
  container.innerHTML = "";
  const selectMap = document.getElementById("employeeSelectMap");
  selectMap.innerHTML = '<option value="all">الكل</option>';

  for(let u of users.filter(x=>x.role==="employee")){
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div>
        <strong>${u.name_ar}</strong> | <span class="${u.status==='active'?'status-active':u.status==='break'?'status-break':'status-inactive'}">${u.status||'نشط'}</span>
        <div class="task-count">مهام: ${u.completed||0} مكتملة / ${u.in_progress||0} قيد التنفيذ / ${u.delayed||0} مؤجلة</div>
      </div>
      <div>
        <button class="btn" onclick="focusEmployeeOnMap(${u.id})">🗺️ عرض الموقع</button>
      </div>
    `;
    container.appendChild(div);
    const opt = document.createElement("option");
    opt.value = u.id;
    opt.textContent = u.name_ar;
    selectMap.appendChild(opt);
  }
}

// ===== الخريطة =====
let map, markers={};
async function initMap(){
  map = L.map('map').setView([30.0444,31.2357],12); // القاهرة
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
  await updateMarkers();
  document.getElementById("employeeSelectMap").addEventListener("change", updateMarkers);
}

async function updateMarkers(){
  const sel = document.getElementById("employeeSelectMap").value;
  const res = await fetch("/locations");
  const locs = await res.json();
  Object.values(markers).forEach(m=>map.removeLayer(m));
  markers = {};
  locs.forEach(l=>{
    if(sel==="all" || l.employee_id==sel){
      const m = L.marker([l.latitude,l.longitude]).addTo(map).bindPopup(`${l.name_ar}`);
      markers[l.employee_id]=m;
    }
  });
  if(sel!=="all" && markers[sel]) map.setView(markers[sel].getLatLng(),14);
}

function focusEmployeeOnMap(id){
  showTab('mapTab');
  document.getElementById("employeeSelectMap").value=id;
  updateMarkers();
}

// ===== مراجعة التقارير =====
async function loadReports(){
  const res = await fetch("/reports");
  const reports = await res.json();
  const container = document.getElementById("reportsList");
  container.innerHTML="";
  reports.forEach(r=>{
    const div = document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <strong>مندوب:</strong> ${r.user_name} | <strong>عميل:</strong> ${r.client_name_ar}<br>
      <strong>ملاحظات:</strong> ${r.notes}<br>
      ${r.images? r.images.map(img=>`<img src="${img}" style="width:60px;height:60px;margin:3px;border-radius:5px;">`).join('') :''}
      ${r.signature? `<div>🖊️ توقيع:<img src="${r.signature}" style="width:80px;height:40px;"></div>` :''}
      <textarea placeholder="إضافة ملاحظات"></textarea>
      <button class="btn" onclick="addReportNote(${r.id}, this.previousElementSibling.value)">إضافة ملاحظة</button>
    `;
    container.appendChild(div);
  });
}

async function addReportNote(reportId,note){
  await fetch(`/reports/${reportId}/note`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({note})});
  alert("تم إضافة الملاحظة");
}

// ===== الإشعارات =====
async function loadNotifications(){
  const res = await fetch("/notifications");
  const notifs = await res.json();
  const container = document.getElementById("notifications");
  container.innerHTML="";
  notifs.forEach(n=>{
    const div = document.createElement("div");
    div.className="notif "+(n.read? "":"unread");
    div.innerHTML=`${n.message} ${n.delay?`⏰ تأخير ${n.delay} دقيقة`:""}`;
    container.appendChild(div);
  });
}

// ===== بدء الصفحة =====
(async()=>{
  await loadEmployees();
  await initMap();
  await loadReports();
  await loadNotifications();
  setInterval(loadNotifications,10000);
})();
</script>
</body>
</html>
