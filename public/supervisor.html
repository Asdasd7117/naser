<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ù„Ù…Ø´Ø±Ù</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <h2>ğŸ“‘ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
  <div id="reports"></div>

  <h2>ğŸ‘¥ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</h2>
  <div id="employeesList"></div>

  <h2>ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† - ØªØªØ¨Ø¹ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</h2>
  <div id="map" style="height:500px;"></div>

  <h2>ğŸ”” Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</h2>
  <form id="notifyForm">
    <select id="notifyEmployee" required>
      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</option>
    </select>
    <input type="text" id="notifyTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±" required>
    <input type="text" id="notifyMessage" placeholder="Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±" required>
    <button type="submit">Ø¥Ø±Ø³Ø§Ù„</button>
  </form>

  <script>
    let map;
    let markers = {};

    // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± =====
    async function loadReports() {
      const res = await fetch("/reports");
      const reports = await res.json();
      const container = document.getElementById("reports");
      container.innerHTML = "";

      reports.forEach(r => {
        const div = document.createElement("div");
        div.style.border = "1px solid #ccc";
        div.style.padding = "5px";
        div.style.marginBottom = "5px";
        div.innerHTML = `
          <p><strong>Ù…Ù†Ø¯ÙˆØ¨:</strong> ${r.users?.name}</p>
          <p><strong>Ù…Ù‡Ù…Ø©:</strong> ${r.tasks?.client_name}</p>
          <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${r.notes}</p>
          <p><strong>ØªÙˆÙ‚ÙŠØ¹:</strong> ${r.client_signature || 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}</p>
        `;
        container.appendChild(div);
      });
    }

    // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† =====
    async function loadEmployees() {
      const res = await fetch("/users");
      const users = await res.json();
      const list = document.getElementById("employeesList");
      const select = document.getElementById("notifyEmployee");
      list.innerHTML = "";
      select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</option>';

      users.filter(u => u.role === "employee").forEach(u => {
        // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ø§Ù…
        const div = document.createElement("div");
        div.style.border = "1px solid #ccc";
        div.style.padding = "8px";
        div.style.marginBottom = "5px";
        div.innerHTML = `<strong>${u.name}</strong> | ID: ${u.id} | Ø­Ø§Ù„Ø©: ${u.status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}`;
        list.appendChild(div);

        // Ø®ÙŠØ§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = u.name;
        select.appendChild(opt);
      });

      return users.filter(u => u.role === "employee");
    }

    // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© =====
    async function initMap() {
      map = L.map('map').setView([24.7136, 46.6753], 5); // Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ÙƒÙ…Ø«Ø§Ù„
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
    }

    async function updateMap() {
      const employees = await loadEmployees();

      employees.forEach(emp => {
        if(emp.latitude && emp.longitude){
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø©
          if(markers[emp.id]) {
            markers[emp.id].setLatLng([emp.latitude, emp.longitude]);
            markers[emp.id].bindPopup(`<strong>${emp.name}</strong><br>Ø­Ø§Ù„Ø©: ${emp.status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}`);
          } else {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù„Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
            const marker = L.marker([emp.latitude, emp.longitude]).addTo(map)
              .bindPopup(`<strong>${emp.name}</strong><br>Ø­Ø§Ù„Ø©: ${emp.status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}`);
            markers[emp.id] = marker;
          }
        }
      });
    }

    // ===== Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± =====
    document.getElementById("notifyForm").addEventListener("submit", async e => {
      e.preventDefault();
      const user_id = document.getElementById("notifyEmployee").value;
      const title = document.getElementById("notifyTitle").value;
      const message = document.getElementById("notifyMessage").value;

      const res = await fetch("/notifications", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id, title, message, type: "manual" })
      });

      if(res.ok) alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±");
      else alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±");
    });

    // ===== Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ =====
    async function refreshData() {
      await loadReports();
      await updateMap();
    }

    async function startAutoRefresh(interval = 10000) {
      await refreshData();
      setInterval(refreshData, interval);
    }

    // ===== Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø© =====
    (async () => {
      await initMap();
      startAutoRefresh(10000); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
    })();
  </script>
</body>
</html>
