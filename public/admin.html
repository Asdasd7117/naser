<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>صفحة المدير</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <h2>لوحة المدير</h2>

  <!-- إضافة مهمة -->
  <h3>إضافة / تعديل مهمة</h3>
  <form id="taskForm">
    <input type="text" id="clientName" placeholder="اسم العميل" required>
    <input type="text" id="clientAddress" placeholder="عنوان العميل" required>
    <input type="time" id="visitTime" required>
    <select id="assignedTo" required>
      <option value="">اختر مندوب</option>
    </select>
    <button type="submit">حفظ المهمة</button>
  </form>

  <!-- المهام -->
  <h3>المهام</h3>
  <div id="tasksContainer"></div>

  <!-- إشعارات -->
  <h3>إرسال إشعارات</h3>
  <input type="text" id="notificationMessage" placeholder="رسالة الإشعار">
  <button id="sendNotificationBtn">إرسال إشعار</button>
</div>

<script type="module">
import { supabase, currentUser, subscribeTable, sendNotification } from './main.js'

// جلب جميع المندوبين لخيارات الاختيار
async function loadAgents(){
  const { data: agents } = await supabase.from('users').select('*').eq('role','agent')
  const select = document.getElementById('assignedTo')
  select.innerHTML='<option value="">اختر مندوب</option>'
  agents.forEach(a=>{
    const opt = document.createElement('option')
    opt.value=a.id
    opt.text=a.email_or_phone
    select.appendChild(opt)
  })
}

// حفظ المهمة
document.getElementById('taskForm').addEventListener('submit', async (e)=>{
  e.preventDefault()
  const client_name = document.getElementById('clientName').value
  const client_address = document.getElementById('clientAddress').value
  const visit_time = document.getElementById('visitTime').value
  const assigned_to = document.getElementById('assignedTo').value

  await supabase.from('tasks').insert([{ client_name, client_address, visit_time, assigned_to, status:'pending' }])
  document.getElementById('taskForm').reset()
})

// جلب وعرض المهام
async function loadTasks(){
  const { data: tasks } = await supabase.from('tasks').select('*').order('visit_time',{ascending:true})
  const container = document.getElementById('tasksContainer')
  container.innerHTML=''
  tasks.forEach(t=>{
    const div = document.createElement('div')
    div.style.border='1px solid #ccc'; div.style.padding='10px'; div.style.margin='5px'; div.style.borderRadius='8px'
    div.innerHTML=`
      <strong>${t.client_name}</strong> - ${t.client_address} <br>
      وقت الزيارة: ${t.visit_time} <br>
      الحالة: ${t.status} <br>
      المندوب: ${t.assigned_to}
    `
    container.appendChild(div)
  })
}

// إرسال إشعار لجميع المندوبين
document.getElementById('sendNotificationBtn').addEventListener('click', async ()=>{
  const message = document.getElementById('notificationMessage').value
  const { data: agents } = await supabase.from('users').select('*').eq('role','agent')
  agents.forEach(a=>sendNotification(a.id,message))
  alert('تم إرسال الإشعار لجميع المندوبين')
  document.getElementById('notificationMessage').value=''
})

// تحديث لحظي للمهام
subscribeTable('tasks', loadTasks)

loadAgents()
loadTasks()
</script>
</body>
</html>
