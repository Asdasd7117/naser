<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    nav {
      display: flex;
      justify-content: space-around;
      background: #2196f3;
      padding: 10px;
      color: white;
    }
    nav button {
      background: transparent;
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    section { display: none; padding: 20px; }
    section.active { display: block; }
    .card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }
    .delete-btn { color: red; cursor: pointer; margin-left: 10px; }
  </style>
</head>
<body>
  <nav>
    <button onclick="showTab('reports')">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    <button onclick="showTab('attendance')">â° Ø§Ù„Ø­Ø¶ÙˆØ±</button>
    <button onclick="showTab('control')">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
  </nav>

  <!-- ===== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ===== -->
  <section id="reports" class="active">
    <h2>ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</h2>
    <canvas id="generalChart" width="400" height="200"></canvas>

    <h3>ğŸ“ˆ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</h3>
    <div id="employeesPerformance"></div>
  </section>

  <!-- ===== Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù ===== -->
  <section id="attendance">
    <h2>â° Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h2>
    <div id="attendanceList"></div>
  </section>

  <!-- ===== Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ===== -->
  <section id="control">
    <h2>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
    <form id="addUserForm">
      <input type="text" id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
      <input type="text" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
      <input type="text" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
      <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
      <select id="role" required>
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±</option>
        <option value="employee">Ù…Ù†Ø¯ÙˆØ¨</option>
        <option value="supervisor">Ù…Ø´Ø±Ù</option>
      </select>
      <button type="submit">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
    </form>
    <div id="usersList"></div>

    <h2>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</h2>
    <form id="addTaskForm">
      <select id="employeeSelect" required></select>
      <input type="text" id="client_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" required>
      <input type="text" id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" required>
      <input type="datetime-local" id="visit_time" required>
      <button type="submit">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</button>
    </form>
    <div id="tasksList"></div>

    <h2>ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
    <form id="notifyForm">
      <textarea id="message" placeholder="Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±" required></textarea>
      <button type="submit">ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ù…Ø§Ø¹ÙŠ</button>
    </form>
  </section>

  <script>
    function showTab(id) {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    // ===== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± =====
    async function loadReports() {
      const res = await fetch("/tasks");
      const tasks = await res.json();

      const completed = tasks.filter(t => t.status === "completed").length;
      const in_progress = tasks.filter(t => t.status === "in_progress").length;
      const delayed = tasks.filter(t => t.status === "delayed").length;

      new Chart(document.getElementById("generalChart"), {
        type: "doughnut",
        data: {
          labels: ["Ù…ÙƒØªÙ…Ù„Ø©", "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°", "Ù…Ø¤Ø¬Ù„Ø©"],
          datasets: [{
            data: [completed, in_progress, delayed],
            backgroundColor: ["#4caf50", "#2196f3", "#f44336"]
          }]
        }
      });

      const perfContainer = document.getElementById("employeesPerformance");
      perfContainer.innerHTML = "";
      const grouped = {};
      tasks.forEach(t => {
        if (!grouped[t.employee_id]) grouped[t.employee_id] = { completed: 0, total: 0 };
        grouped[t.employee_id].total++;
        if (t.status === "completed") grouped[t.employee_id].completed++;
      });
      for (let emp in grouped) {
        const p = Math.round((grouped[emp].completed / grouped[emp].total) * 100);
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<strong>Ù…Ù†Ø¯ÙˆØ¨ ID ${emp}</strong> - Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²: ${p}%`;
        perfContainer.appendChild(div);
      }
    }

    // ===== Ø§Ù„Ø­Ø¶ÙˆØ± =====
    async function loadAttendance() {
      const res = await fetch("/attendance");
      const data = await res.json();
      const container = document.getElementById("attendanceList");
      container.innerHTML = "";
      data.forEach(a => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <strong>${a.user_name}</strong><br>
          Ø¯Ø®ÙˆÙ„: ${a.check_in} - Ø®Ø±ÙˆØ¬: ${a.check_out || "Ù„Ù… ÙŠØ³Ø¬Ù„ Ø®Ø±ÙˆØ¬"}
        `;
        container.appendChild(div);
      });
    }

    // ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† =====
    document.getElementById("addUserForm").addEventListener("submit", async e => {
      e.preventDefault();
      const payload = {
        name_ar: document.getElementById("name").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
        password: document.getElementById("password").value,
        role: document.getElementById("role").value
      };
      const res = await fetch("/add-user", {
        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
      });
      if (res.ok) { alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"); loadUsers(); loadEmployees(); }
    });

    async function loadUsers() {
      const res = await fetch("/users");
      const users = await res.json();
      const container = document.getElementById("usersList");
      container.innerHTML = "";
      users.forEach(u => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          ${u.name_ar} | ${u.role} | ${u.email || u.phone}
          <span class="delete-btn" onclick="deleteUser(${u.id})">ğŸ—‘ Ø­Ø°Ù</span>
        `;
        container.appendChild(div);
      });
    }

    async function deleteUser(id) {
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) return;
      const res = await fetch(`/users/${id}`, { method: "DELETE" });
      if (res.ok) { alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"); loadUsers(); loadEmployees(); loadTasks(); }
    }

    async function loadEmployees() {
      const res = await fetch("/users");
      const users = await res.json();
      const select = document.getElementById("employeeSelect");
      select.innerHTML = "<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</option>";
      users.filter(u => u.role === "employee").forEach(u => {
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = u.name_ar;
        select.appendChild(opt);
      });
    }

    // ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… =====
    document.getElementById("addTaskForm").addEventListener("submit", async e => {
      e.preventDefault();
      const payload = {
        employee_id: document.getElementById("employeeSelect").value,
        client_name_ar: document.getElementById("client_name").value,
        address_ar: document.getElementById("address").value,
        visit_time: document.getElementById("visit_time").value
      };
      const res = await fetch("/tasks", {
        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
      });
      if (res.ok) { alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©"); loadTasks(); }
    });

    async function loadTasks() {
      const res = await fetch("/tasks");
      const tasks = await res.json();
      const container = document.getElementById("tasksList");
      container.innerHTML = "";
      tasks.forEach(t => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <strong>${t.client_name_ar}</strong> - Ø§Ù„Ø­Ø§Ù„Ø©: ${t.status || "Ø¬Ø¯ÙŠØ¯Ø©"}
          <span class="delete-btn" onclick="deleteTask(${t.id})">ğŸ—‘ Ø­Ø°Ù</span>
        `;
        container.appendChild(div);
      });
    }

    async function deleteTask(id) {
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ")) return;
      const res = await fetch(`/tasks/${id}`, { method: "DELETE" });
      if (res.ok) { alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©"); loadTasks(); loadReports(); }
    }

    // ===== Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª =====
    document.getElementById("notifyForm").addEventListener("submit", async e => {
      e.preventDefault();
      const message = document.getElementById("message").value;
      // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù‡Ù…
      const resUsers = await fetch("/users");
      const users = await resUsers.json();
      for (let u of users) {
        await fetch("/notifications", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: u.id,
            title_ar: "Ø¥Ø´Ø¹Ø§Ø± Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ±",
            title_en: "Manager Notification",
            message_ar: message,
            message_en: message,
            type: "individual"
          })
        });
      }
      alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†");
    });

    // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙ„ =====
    loadReports();
    loadAttendance();
    loadUsers();
    loadEmployees();
    loadTasks();
  </script>
</body>
</html>
