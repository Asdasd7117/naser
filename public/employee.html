<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { font-family: Tahoma, sans-serif; background: #f5f7fa; margin: 20px; }
        h1 { text-align: center; color: #333; margin-bottom: 25px; }
        section { margin-bottom: 25px; }
        .card { padding: 12px; margin: 10px 0; border-radius: 10px; color: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .status-new { background: #42a5f5; }
        .status-in_progress { background: #ff9800; }
        .status-completed { background: #4caf50; }
        .status-delayed { background: #e53935; }
        button { margin: 3px; padding: 7px 12px; border: none; border-radius: 6px; cursor: pointer; background: #607d8b; color: white; }
        button:hover { opacity: 0.9; }
        form input, form textarea { width: 100%; padding: 8px; margin: 6px 0; border-radius: 6px; border: 1px solid #ccc; }
        #map { height: 300px; border-radius: 10px; margin-top: 10px; }
        #notifications .card { background: #2196f3; }
    </style>
</head>
<body>
    <h1>ğŸ‘· Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</h1>

    <section>
        <h2>ğŸ“‹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
        <div id="tasks">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…...</div>
    </section>

    <section>
        <h2>ğŸ“ Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h2>
        <form id="reportForm">
            <input type="hidden" id="task_id">
            <textarea id="notes" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>
            <input type="file" id="images" multiple>
            <input type="file" id="signature" accept="image/*">
            <button type="submit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </form>
    </section>

    <section>
        <h2>ğŸ—ºï¸ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        <div id="map"></div>
    </section>

    <section>
        <h2>ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
        <div id="notifications">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...</div>
    </section>

    <script>
        const BASE_URL = "https://naser700.onrender.com";
        const USER_ID = 3; // ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø®ØªÙ„ÙØ§Ù‹

        let map, marker;

        // ===== Ø§Ù„Ù…Ù‡Ø§Ù… =====
        async function loadTasks() {
            try {
                const res = await fetch(`${BASE_URL}/tasks?employee_id=${USER_ID}`, {
                    method: "GET",
                    headers: { "Content-Type": "application/json" }
                });
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP error! status: ${res.status}, response: ${errorText}`);
                }
                const tasks = await res.json();
                console.log("Tasks received:", tasks); // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ù‚Ù‚
                const container = document.getElementById("tasks");
                container.innerHTML = "";
                if (!tasks || tasks.length === 0) {
                    container.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹";
                    return;
                }
                tasks.forEach(task => {
                    const div = document.createElement("div");
                    div.className = "card";
                    let content = "<ul>";
                    for (let key in task) {
                        if (task.hasOwnProperty(key)) {
                            content += `<li><strong>${key}:</strong> ${task[key] || "-"}</li>`;
                        }
                    }
                    content += "</ul>";
                    div.innerHTML = content;
                    if (task.id && task.hasOwnProperty("status")) {
                        div.innerHTML += `
                            <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span id="status-${task.id}">${task.status || "Ù…Ù†ÙØµÙ„Ø©"}</span></p>
                            <button onclick="updateStatus(${task.id}, 'in_progress')">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</button>
                            <button onclick="updateStatus(${task.id}, 'completed')">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</button>
                            <button onclick="updateStatus(${task.id}, 'delayed')">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</button>
                            <button onclick="selectTask(${task.id})">Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ±</button>
                        `;
                    }
                    container.appendChild(div);
                });
            } catch (e) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…:", e);
                document.getElementById("tasks").innerHTML = `ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…. Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${e.message}`;
            }
        }

        function selectTask(taskId) {
            document.getElementById("task_id").value = taskId;
        }

        async function updateStatus(taskId, status) {
            try {
                const res = await fetch(`${BASE_URL}/tasks/${taskId}/status`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ status })
                });
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                document.getElementById(`status-${taskId}`).innerText = status;
                loadTasks();
            } catch (e) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©:", e);
            }
        }

        // ===== Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± =====
        document.getElementById("reportForm").addEventListener("submit", async e => {
            e.preventDefault();
            const task_id = document.getElementById("task_id").value || null;
            const notes = document.getElementById("notes").value || "";

            const imagesFiles = document.getElementById("images").files;
            const signatureFile = document.getElementById("signature").files[0];

            const formData = new FormData();
            if (task_id) formData.append("task_id", task_id);
            formData.append("user_id", USER_ID);
            if (notes) formData.append("notes", notes);

            for (let i = 0; i < imagesFiles.length; i++) {
                formData.append("images", imagesFiles[i]);
            }
            if (signatureFile) formData.append("signature", signatureFile);

            try {
                const res = await fetch(`${BASE_URL}/reports`, {
                    method: "POST",
                    body: formData
                });
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP error! status: ${res.status}, response: ${errorText}`);
                }
                alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­");
                document.getElementById("reportForm").reset();
                loadNotifications();
            } catch (e) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:", e);
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (ØªÙØ§ØµÙŠÙ„ Ø¨Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„)");
            }
        });

        // ===== Ø§Ù„Ø®Ø±ÙŠØ·Ø© =====
        async function initMap() {
            map = L.map('map').setView([30.0444, 31.2357], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            if (navigator.geolocation) {
                setInterval(() => {
                    navigator.geolocation.getCurrentPosition(
                        async pos => {
                            const lat = pos.coords.latitude, lon = pos.coords.longitude;
                            try {
                                const res = await fetch(`${BASE_URL}/locations`, {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify({ employee_id: USER_ID, latitude: lat, longitude: lon })
                                });
                                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                            } catch (e) {
                                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹:", e);
                            }

                            if (!marker) {
                                marker = L.marker([lat, lon]).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ");
                            } else {
                                marker.setLatLng([lat, lon]);
                            }
                            map.setView([lat, lon], 13);
                        },
                        err => {
                            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹:", err);
                        },
                        { timeout: 10000 }
                    );
                }, 15000);
            }
        }

        // ===== Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª =====
        async function loadNotifications() {
            try {
                const res = await fetch(`${BASE_URL}/notifications/${USER_ID}`, {
                    method: "GET",
                    headers: { "Content-Type": "application/json" }
                });
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP error! status: ${res.status}, response: ${errorText}`);
                }
                const notifs = await res.json();
                console.log("Notifications received:", notifs); // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ù‚Ù‚
                const container = document.getElementById("notifications");
                container.innerHTML = "";
                if (!notifs || notifs.length === 0) {
                    container.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹";
                    return;
                }
                notifs.forEach(notif => {
                    const div = document.createElement("div");
                    div.className = "card";
                    div.style.background = "#2196f3";
                    let content = "<ul>";
                    for (let key in notif) {
                        if (notif.hasOwnProperty(key)) {
                            content += `<li><strong>${key}:</strong> ${notif[key] || "-"}</li>`;
                        }
                    }
                    content += "</ul>";
                    div.innerHTML = content;
                    container.appendChild(div);
                });
            } catch (e) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:", e);
                document.getElementById("notifications").innerHTML = `ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª. Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${e.message}`;
            }
        }

        // ===== Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø© =====
        (async () => {
            await loadTasks();
            await initMap();
            await loadNotifications();
            setInterval(loadNotifications, 10000);
        })();
    </script>
</body>
</html>
