<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المندوب</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:20px; background:#f5f5f5; }
h1, h2 { text-align:center; color:#333; }
section { margin-bottom:20px; }
.card { padding:10px; margin:10px 0; border-radius:8px; color:white; }
.status-new { background:#90caf9; }          
.status-in_progress { background:#ffb74d; }  
.status-completed { background:#81c784; }    
.status-delayed { background:#e57373; }      
button { margin:2px; padding:5px 10px; border:none; border-radius:5px; cursor:pointer; }
form input, form textarea { width:100%; padding:8px; margin:5px 0; border-radius:5px; border:1px solid #ccc; }
</style>
</head>
<body>

<h1>👷 لوحة المندوب</h1>

<section>
  <h2>📋 المهام اليومية</h2>
  <div id="tasks">جاري التحميل...</div>
</section>

<section>
  <h2>📝 رفع التقرير</h2>
  <form id="reportForm">
    <input type="hidden" id="task_id">
    <textarea id="notes" placeholder="اكتب ملاحظاتك هنا..." required></textarea>
    <input type="file" id="images" multiple>
    <button type="submit">إرسال التقرير</button>
  </form>
</section>

<section>
  <h2>🔔 الإشعارات</h2>
  <div id="notifications">جاري التحميل...</div>
</section>

<script>
// ===== إعداد Supabase =====
const SUPABASE_URL = "https://ncjxqfqwswwikedaffif.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5janhxZnF3c3d3aWtlZGFmZmlmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Nzg0MTA3NCwiZXhwIjoyMDczNDE3MDc0fQ.ZX7giBBgWRScW6usplziAWjNYn9yCVeLVAQz7YUBjvA";
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);

// ===== معرف المندوب =====
const USER_ID = 3;

// ===== تحميل المهام =====
async function loadTasks() {
  const { data: tasks, error } = await supabase
    .from("tasks")
    .select("*")
    .eq("employee_id", USER_ID)
    .order("visit_time", { ascending: true });

  const container = document.getElementById("tasks");
  if(error) return container.innerHTML = "خطأ في تحميل المهام: " + error.message;
  if(!tasks || tasks.length===0) return container.innerHTML = "لا توجد مهام لهذا اليوم.";

  container.innerHTML = "";
  tasks.forEach(t=>{
    const statusClass = "status-" + (t.status || "new");
    const div = document.createElement("div");
    div.className = "card " + statusClass;
    div.innerHTML = `
      <p><strong>المهمة:</strong> ${t.client_name_ar || "-"}</p>
      <p><strong>العنوان:</strong> ${t.address_ar || "-"}</p>
      <p><strong>وقت الزيارة:</strong> ${t.visit_time ? new Date(t.visit_time).toLocaleString() : "-"}</p>
      <p><strong>الحالة:</strong> <span id="status-${t.id}">${t.status || "منفصلة"}</span></p>
      <button onclick="selectTask(${t.id})">رفع تقرير</button>
    `;
    container.appendChild(div);
  });
}

// ===== اختيار مهمة للتقرير =====
function selectTask(taskId){
  document.getElementById("task_id").value = taskId;
}

// ===== رفع التقرير =====
document.getElementById("reportForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const task_id = document.getElementById("task_id").value;
  const notes = document.getElementById("notes").value;
  const files = document.getElementById("images").files;

  const formData = new FormData();
  formData.append("task_id", task_id);
  formData.append("user_id", USER_ID);
  formData.append("notes", notes);
  for(let i=0;i<files.length;i++) formData.append("images", files[i]);

  const res = await fetch("/reports", { method:"POST", body: formData });
  if(res.ok) alert("✅ تم إرسال التقرير بنجاح");
  else alert("❌ خطأ في إرسال التقرير");
});

// ===== تحميل الإشعارات =====
async function loadNotifications(){
  const { data: notifs, error } = await supabase
    .from("notifications")
    .select("*")
    .order("id", { ascending: false });

  const container = document.getElementById("notifications");
  if(error) return container.innerHTML = "خطأ في تحميل الإشعارات: "+error.message;
  if(!notifs || notifs.length===0) return container.innerHTML = "لا توجد إشعارات.";

  container.innerHTML = "";
  notifs.forEach(n=>{
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<strong>${n.title_ar}</strong>: ${n.message_ar}`;
    container.appendChild(div);
  });
}

// ===== بدء الصفحة =====
(async ()=>{
  await loadTasks();
  await loadNotifications();
  setInterval(loadNotifications, 10000);
})();
</script>

</body>
</html>
