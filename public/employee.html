<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>📋 صفحة المندوب</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: Tahoma, sans-serif; background:#f5f5f5; padding:20px; }
    h2 { color:#333; }
    .card { background:white; padding:15px; margin:10px 0; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .btn { padding:10px 15px; border:none; border-radius:5px; cursor:pointer; }
    .btn-primary { background:#007bff; color:white; }
  </style>
</head>
<body>
  <h2>📌 مهامي</h2>
  <div id="tasks"></div>

  <h2>🔔 الإشعارات</h2>
  <div id="notifications"></div>

  <h2>📝 إرسال تقرير</h2>
  <form id="reportForm">
    <textarea id="reportText" placeholder="اكتب تقريرك هنا..." required></textarea><br>
    <button type="submit" class="btn btn-primary">إرسال</button>
  </form>

  <script>
    // 🔑 بيانات Supabase
    const SUPABASE_URL = "https://ncjxqfwwswikedaffif.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5janhxZnF3c3d3aWtlZGFmZmlmIiwicm9sZSI6InJvbGUiLCJpYXQiOjE3NTc4NDEwNzQsImV4cCI6MjA3MzQxNzA3NH0.lZCcHkDqW7Xhy_yP8P9dxY6U1KFeLrNJSugRMTi4JtU";

    // ✅ التصحيح هنا: نستخدم createClient من المكتبة وليس من متغير بنفس الاسم
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 📌 المستخدم الحالي (مؤقت)
    const currentUserId = "delegate-123"; 

    // 🟢 تحميل المهام
    async function loadTasks() {
      const { data, error } = await client
        .from("tasks")
        .select("*")
        .eq("user_id", currentUserId);

      if (error) {
        console.error("خطأ في تحميل المهام:", error.message);
        return;
      }

      const tasksDiv = document.getElementById("tasks");
      tasksDiv.innerHTML = "";
      data.forEach(task => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<b>${task.title || "مهمة"}</b><br>${task.description || ""}`;
        tasksDiv.appendChild(card);
      });
    }

    // 🟢 تحميل الإشعارات
    async function loadNotifications() {
      const { data, error } = await client
        .from("notifications")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("خطأ في تحميل الإشعارات:", error.message);
        return;
      }

      const notiDiv = document.getElementById("notifications");
      notiDiv.innerHTML = "";
      data.forEach(noti => {
        const card = document.createElement("div");
        card.className = "card";
        card.textContent = noti.message || "إشعار";
        notiDiv.appendChild(card);
      });
    }

    // 🟢 إرسال تقرير
    document.getElementById("reportForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const reportText = document.getElementById("reportText").value;

      const { error } = await client
        .from("reports")
        .insert([{ text: reportText, user_id: currentUserId }]);

      if (error) {
        console.error("❌ خطأ في إرسال التقرير:", error.message);
        alert("فشل إرسال التقرير!");
      } else {
        alert("✅ تم إرسال التقرير بنجاح!");
        document.getElementById("reportForm").reset();
      }
    });

    // 🚀 تشغيل أولي
    loadTasks();
    loadNotifications();
  </script>
</body>
</html>
