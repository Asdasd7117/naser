<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المندوب</title>
<link rel="stylesheet" href="assets/style.css">
<style>
.map { width: 100%; height: 300px; margin-top: 10px; }
.task-card { border:1px solid #ccc; padding:10px; margin-bottom:10px; border-radius:5px; }
button.update-status { margin-top:5px; }
</style>
</head>
<body>
<header><h2>لوحة المندوب</h2></header>

<nav>
<button onclick="showSection('tasks')">المهام اليومية</button>
<button onclick="showSection('report')">رفع التقرير</button>
<button onclick="showSection('map')">الخريطة</button>
<button onclick="showSection('notifications')">الإشعارات</button>
</nav>

<div class="container">
<!-- المهام اليومية -->
<div id="tasks" class="card">
<h3>المهام اليومية</h3>
<div id="taskList"></div>
</div>

<!-- رفع التقرير -->
<div id="report" class="card" style="display:none;">
<h3>رفع التقرير</h3>
<textarea id="reportNotes" placeholder="الملاحظات"></textarea><br>
<input type="file" id="reportImages" multiple><br>
<input type="text" id="clientSignature" placeholder="توقيع العميل"><br>
<button onclick="submitReport()">إرسال التقرير</button>
</div>

<!-- الخريطة -->
<div id="map" class="card" style="display:none;">
<h3>الخريطة</h3>
<div id="mapDiv" class="map"></div>
</div>

<!-- الإشعارات -->
<div id="notifications" class="card" style="display:none;">
<h3>الإشعارات</h3>
<ul id="notifList"></ul>
</div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>

<script>
const SUPABASE_URL = 'https://ncjxqfqwswwikedaffif.supabase.co';
const SUPABASE_KEY = 'ZX7giBBgWRScW6usplziAWjNYn9yCVeLVAQz7YUBjvA';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let employeeId = prompt('ادخل ID المندوب'); // للتجربة، لاحقاً يمكن تسجيل الدخول

function showSection(section){
  document.querySelectorAll(".card").forEach(c=>c.style.display='none');
  document.getElementById(section).style.display='block';
}

// تحميل المهام
async function loadTasks(){
  const { data: tasks } = await supabase.from('tasks').select('*').eq('agent_id', employeeId);
  const container = document.getElementById('taskList');
  container.innerHTML='';
  tasks.forEach(t=>{
    const div = document.createElement('div');
    div.className='task-card';
    div.innerHTML=`
      <strong>${t.client_name}</strong><br>
      ${t.address}<br>
      ${t.visit_time}<br>
      الحالة: ${t.status}<br>
      <button class="update-status" onclick="updateTaskStatus(${t.id})">تحديث الحالة</button>
    `;
    container.appendChild(div);
  });
}

// تحديث الحالة
async function updateTaskStatus(taskId){
  const newStatus = prompt('ادخل الحالة الجديدة: قيد التنفيذ / مكتملة / مؤجلة');
  if(newStatus){
    await supabase.from('tasks').update({status:newStatus}).eq('id',taskId);
    loadTasks();
  }
}

// رفع التقرير
async function submitReport(){
  const notes = document.getElementById('reportNotes').value;
  const files = document.getElementById('reportImages').files;
  const signature = document.getElementById('clientSignature').value;

  let fileUrls = [];
  for(let f of files){
    const { data, error } = await supabase.storage.from('reports').upload(`report_${Date.now()}_${f.name}`, f);
    if(data) fileUrls.push(data.path);
  }

  await supabase.from('reports').insert([{
    agent_id: employeeId,
    notes, images: fileUrls, signature
  }]);

  alert('تم رفع التقرير');
}

// الخريطة
async function loadMap(){
  const mapDiv = document.getElementById('mapDiv');
  mapDiv.innerHTML='';
  const map = L.map('mapDiv').setView([24.7136,46.6753], 13); // مركز السعودية
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'&copy; OpenStreetMap'}).addTo(map);

  // مواقع الزيارات السابقة
  const { data: tasks } = await supabase.from('tasks').select('*').eq('agent_id', employeeId);
  tasks.forEach(t=>{
    if(t.lat && t.lng) L.marker([t.lat, t.lng]).addTo(map).bindPopup(`${t.client_name}`);
  });

  // موقع الموظف الحالي (مثال عشوائي)
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      L.marker([lat,lng], {color:'red'}).addTo(map).bindPopup('موقعك الحالي');
      map.setView([lat,lng],14);
    });
  }
}

// الإشعارات
async function loadNotifications(){
  const { data: tasks } = await supabase.from('tasks').select('*').eq('agent_id', employeeId);
  const list = document.getElementById('notifList');
  list.innerHTML='';
  const now = new Date();
  tasks.forEach(t=>{
    const visitTime = new Date(t.visit_time);
    if(t.status==='قيد التنفيذ' && visitTime < now){
      const li = document.createElement('li');
      li.innerText = `تأخر بدء مهمة: ${t.client_name}`;
      list.appendChild(li);
    }
  });
}

// تحميل البيانات أول مرة
loadTasks();
loadMap();
loadNotifications();
</script>
</body>
</html>
