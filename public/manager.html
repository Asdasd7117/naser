<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„Ù…Ø¯ÙŠØ±</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù‡Ø§Ù…</h2>
  <canvas id="statsChart" width="400" height="200"></canvas>

  <section>
    <h2>ğŸ‘¥ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h2>
    <form id="addUserForm">
      <input type="text" id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
      <input type="text" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
      <input type="text" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
      <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
      <select id="role" required>
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±</option>
        <option value="employee">Ù…Ù†Ø¯ÙˆØ¨</option>
        <option value="supervisor">Ù…Ø´Ø±Ù</option>
      </select>
      <button type="submit">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
    </form>

    <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
    <div id="usersList"></div>
  </section>

  <section>
    <h2>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
    <form id="addTaskForm">
      <select id="employeeSelect" required>
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</option>
      </select>
      <input type="text" id="client_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" required>
      <input type="text" id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" required>
      <input type="datetime-local" id="visit_time" required>
      <button type="submit">Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</button>
    </form>

    <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</h3>
    <div id="tasksList"></div>
  </section>

  <script>
    // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª =====
    async function loadStats() {
      try {
        const res = await fetch("/tasks");
        const tasks = await res.json();

        const completed = tasks.filter(t => t.status === "completed").length;
        const in_progress = tasks.filter(t => t.status === "in_progress").length;
        const delayed = tasks.filter(t => t.status === "delayed").length;

        new Chart(document.getElementById("statsChart"), {
          type: "doughnut",
          data: {
            labels: ["Ù…ÙƒØªÙ…Ù„Ø©", "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°", "Ù…Ø¤Ø¬Ù„Ø©"],
            datasets: [{
              data: [completed, in_progress, delayed],
              backgroundColor: ["#4caf50", "#2196f3", "#f44336"]
            }]
          }
        });
      } catch (err) {
        console.error(err);
      }
    }

    // ===== Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… =====
    document.getElementById("addUserForm").addEventListener("submit", async e => {
      e.preventDefault();
      const name = document.getElementById("name").value;
      const email = document.getElementById("email").value;
      const phone = document.getElementById("phone").value;
      const password = document.getElementById("password").value;
      const role = document.getElementById("role").value;

      try {
        const res = await fetch("/add-user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            name_ar: name, 
            name_en: name, 
            email, 
            phone, 
            password, 
            role 
          })
        });

        const data = await res.json();
        if (res.ok) {
          alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­");
          loadUsers();
          loadEmployees();
        } else {
          alert("âŒ Ø®Ø·Ø£: " + (data.error || "Ø­Ø¯Ø« Ø®Ø·Ø£"));
        }
      } catch (err) {
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
        console.error(err);
      }
    });

    // ===== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† =====
    async function loadUsers() {
      try {
        const res = await fetch("/users");
        const users = await res.json();
        const container = document.getElementById("usersList");
        container.innerHTML = "";

        users.forEach(u => {
          const div = document.createElement("div");
          div.style.border = "1px solid #ccc";
          div.style.padding = "8px";
          div.style.marginBottom = "5px";
          div.innerHTML = `
            <strong>${u.name_ar}</strong> | ${u.role} | ${u.email || u.phone}
            <button onclick="deleteUser(${u.id})" style="margin-left:10px;color:red;">Ø­Ø°Ù</button>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        console.error(err);
      }
    }

    async function deleteUser(userId) {
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) return;
      const res = await fetch(`/users/${userId}`, { method: "DELETE" });
      if (res.ok) loadUsers();
      else alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø°Ù");
    }

    // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© =====
    async function loadEmployees() {
      try {
        const res = await fetch("/users");
        const users = await res.json();
        const select = document.getElementById("employeeSelect");
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</option>';
        users.filter(u => u.role === "employee").forEach(u => {
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = u.name_ar;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // ===== Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© =====
    document.getElementById("addTaskForm").addEventListener("submit", async e => {
      e.preventDefault();
      const employee_id = document.getElementById("employeeSelect").value;
      const client_name = document.getElementById("client_name").value;
      const address = document.getElementById("address").value;
      const visit_time = document.getElementById("visit_time").value;

      try {
        const res = await fetch("/tasks", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            employee_id, 
            client_name_ar: client_name, 
            client_name_en: client_name, 
            address_ar: address, 
            address_en: address, 
            visit_time 
          })
        });

        const data = await res.json();
        if (res.ok) {
          alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©");
          loadTasks();
        } else {
          alert("âŒ Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©: " + (data.error || "Ø­Ø¯Ø« Ø®Ø·Ø£"));
        }
      } catch (err) {
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©");
        console.error(err);
      }
    });

    // ===== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… =====
    async function loadTasks() {
      try {
        const res = await fetch("/tasks");
        const tasks = await res.json();
        const container = document.getElementById("tasksList");
        container.innerHTML = "";

        tasks.forEach(task => {
          const div = document.createElement("div");
          div.style.border = "1px solid #ccc";
          div.style.padding = "8px";
          div.style.marginBottom = "5px";
          div.innerHTML = `
            <strong>Ù…Ù†Ø¯ÙˆØ¨:</strong> ${task.users?.name_ar || task.employee_id} |
            <strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${task.client_name_ar} |
            <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${task.status || 'Ø¬Ø¯ÙŠØ¯Ø©'}
            <button onclick="deleteTask(${task.id})" style="color:red;">Ø­Ø°Ù</button>
            <button onclick="updateTaskStatus(${task.id}, 'completed')">ØªÙ…Øª</button>
            <button onclick="updateTaskStatus(${task.id}, 'in_progress')">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</button>
            <button onclick="updateTaskStatus(${task.id}, 'delayed')">Ù…Ø¤Ø¬Ù„Ø©</button>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        console.error(err);
      }
    }

    async function deleteTask(taskId) {
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ")) return;
      const res = await fetch(`/tasks/${taskId}`, { method: "DELETE" });
      if (res.ok) loadTasks();
      else alert("âŒ Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø°Ù");
    }

    async function updateTaskStatus(taskId, status) {
      try {
        await fetch(`/tasks/${taskId}/status`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status })
        });
        loadTasks();
      } catch (err) {
        console.error(err);
      }
    }

    // ===== ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© =====
    loadStats();
    loadUsers();
    loadEmployees();
    loadTasks();
  </script>
</body>
</html>
