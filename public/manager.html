<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المدير</title>
<link rel="stylesheet" href="assets/style.css">
</head>
<body>
<header>
<h2>لوحة المدير</h2>
</header>

<nav>
<button onclick="showSection('analytics')">التقارير والتحليلات</button>
<button onclick="showSection('attendance')">الحضور والانصراف</button>
<button onclick="showSection('control')">لوحة التحكم</button>
</nav>

<div class="container">
<!-- التقارير -->
<div class="card" id="analytics">
<h3>التقارير والتحليلات</h3>
<table>
<thead><tr><th>المندوب</th><th>المهام المكتملة</th><th>المهام المؤجلة</th></tr></thead>
<tbody id="analyticsList"></tbody>
</table>
</div>

<!-- الحضور -->
<div class="card" id="attendance" style="display:none;">
<h3>الحضور والانصراف</h3>
<table>
<thead><tr><th>المندوب</th><th>ساعات العمل</th></tr></thead>
<tbody id="attendanceList"></tbody>
</table>
</div>

<!-- التحكم -->
<div class="card" id="control" style="display:none;">
<h3>لوحة التحكم</h3>
<button onclick="addAgent('employee')">إضافة مندوب</button>
<button onclick="addAgent('supervisor')">إضافة مشرف</button>
<button onclick="deleteAgent()">حذف مستخدم</button>
<button onclick="addTask()">إضافة مهمة</button>
</div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
const SUPABASE_URL = 'https://ncjxqfqwswwikedaffif.supabase.co';
const SUPABASE_KEY = 'ZX7giBBgWRScW6usplziAWjNYn9yCVeLVAQz7YUBjvA';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function showSection(section){
  document.querySelectorAll(".card").forEach(c=>c.style.display='none');
  document.getElementById(section).style.display='block';
}

// تحميل التحليلات
async function loadAnalytics(){
  const { data: tasks } = await supabase.from('tasks').select('*');
  const { data: users } = await supabase.from('users').select('*').eq('role','employee');
  const tbody = document.getElementById('analyticsList');
  tbody.innerHTML='';
  users.forEach(u=>{
    let completed = tasks.filter(t=>t.agent_id===u.id && t.status==='مكتملة').length;
    let delayed = tasks.filter(t=>t.agent_id===u.id && t.status==='مؤجلة').length;
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${u.email}</td><td>${completed}</td><td>${delayed}</td>`;
    tbody.appendChild(tr);
  });
}

// تحميل الحضور
async function loadAttendance(){
  const { data: attendance } = await supabase.from('attendance').select('*');
  const { data: users } = await supabase.from('users').select('*').eq('role','employee');
  const tbody = document.getElementById('attendanceList');
  tbody.innerHTML='';
  users.forEach(u=>{
    const record = attendance.find(a=>a.agent_id===u.id);
    const hours = record ? record.hours_worked : 0;
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${u.email}</td><td>${hours}</td>`;
    tbody.appendChild(tr);
  });
}

// إضافة مستخدم
async function addAgent(role){
  const email = prompt('أدخل البريد الإلكتروني أو رقم الهاتف:');
  const password = prompt('أدخل كلمة المرور:');
  if(email && password){
    await supabase.from('users').insert([{email,password,role}]);
    alert('تم الإضافة!');
    loadAnalytics(); loadAttendance();
  }
}

// حذف مستخدم
async function deleteAgent(){
  const email = prompt('أدخل البريد الإلكتروني لحذف المستخدم:');
  if(email){
    await supabase.from('users').delete().eq('email',email);
    alert('تم الحذف!');
    loadAnalytics(); loadAttendance();
  }
}

// إضافة مهمة
async function addTask(){
  const agent_id = prompt('ادخل ID المندوب:');
  const client_name = prompt('اسم العميل:');
  const address = prompt('العنوان:');
  const visit_time = prompt('وقت الزيارة:');
  if(agent_id && client_name && address && visit_time){
    await supabase.from('tasks').insert([{agent_id,client_name,address,visit_time,status:'قيد التنفيذ'}]);
    alert('تم إضافة المهمة!');
    loadAnalytics();
  }
}

// تحميل البيانات عند فتح الصفحة
loadAnalytics(); loadAttendance();
</script>
</body>
</html>
