<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f2f5; direction: rtl;}
header { background:#007bff; color:#fff; padding:15px; display:flex; justify-content:space-between; align-items:center;}
header h1 { margin:0; font-size:18px;}
header .time { font-size:14px;}
.lang-switch { position:absolute; top:15px; right:15px; background:#ffc107; color:#000; border:none; padding:8px; border-radius:6px; cursor:pointer;}
.container { padding:20px; max-width:1200px; margin:auto;}
nav { display:flex; justify-content:space-around; margin-bottom:20px; flex-wrap:wrap;}
nav button { padding:10px 20px; border:none; border-radius:8px; cursor:pointer; background:#28a745; color:#fff; font-weight:bold; margin:5px;}
nav button.active { background:#218838;}
section { display:none; }
section.active { display:block; }
.card { background:#fff; padding:15px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin-bottom:15px;}
table { width:100%; border-collapse: collapse;}
table th, table td { border:1px solid #ccc; padding:8px; text-align:center;}
label { display:block; margin-top:10px;}
input, select, textarea, button { width:100%; padding:8px; margin-top:5px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;}
button.action-btn { width:auto; margin:2px; background:#dc3545; color:#fff; }
.error-msg { color:red; font-weight:bold; margin:10px 0; }
</style>
</head>
<body>

<header>
    <h1 id="header-name">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</h1>
    <div class="time" id="current-time">00:00:00</div>
</header>
<button class="lang-switch" id="lang-switch">Switch Language</button>

<nav>
    <button onclick="showSection('users')" id="btn-users">Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
    <button onclick="showSection('tasks')" id="btn-tasks">Ø§Ù„Ù…Ù‡Ø§Ù…</button>
    <button onclick="showSection('attendance')" id="btn-attendance">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
    <button onclick="showSection('reports')" id="btn-reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
</nav>

<div class="container">
<div id="error-msg" class="error-msg"></div>

<section id="users">
    <h2 id="users-title">Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
    <h3 id="add-user-title">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
    <label id="role-label">Ø§Ù„Ø¯ÙˆØ±</label>
    <select id="user-role">
        <option value="supervisor">Ù…Ø´Ø±Ù</option>
        <option value="employee">Ù…Ù†Ø¯ÙˆØ¨</option>
    </select>
    <label id="phone-label">Ø§Ù„Ù‡Ø§ØªÙ</label>
    <input type="text" id="user-phone">
    <label id="email-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
    <input type="text" id="user-email">
    <label id="pass-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input type="text" id="user-pass">
    <button onclick="addUser()" id="add-btn">â• Ø¥Ø¶Ø§ÙØ©</button>

    <h3 id="current-users-title">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ†</h3>
    <table id="users-table">
        <thead>
            <tr>
                <th id="th-role">Ø§Ù„Ø¯ÙˆØ±</th>
                <th id="th-phone">Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th id="th-email">Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                <th id="th-pass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th>
                <th id="th-actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</section>

<section id="tasks">
    <h2 id="tasks-title">Ø§Ù„Ù…Ù‡Ø§Ù…</h2>
    <label id="task-emp-label">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</label>
    <select id="task-employee"></select>
    <label id="task-title-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©</label>
    <input type="text" id="task-title">
    <label id="task-desc-label">Ø§Ù„ÙˆØµÙ</label>
    <textarea id="task-desc"></textarea>
    <label id="task-datetime-label">ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª</label>
    <input type="datetime-local" id="task-datetime">
    <button onclick="saveTask()" id="task-save-btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
</section>

<section id="attendance">
    <h2 id="attendance-title">Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
    <div id="attendance-cards"></div>
</section>

<section id="reports">
    <h2 id="reports-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
    <canvas id="taskChart" style="max-height:300px;"></canvas>
</section>

</div>

<script type="module">
import { fetchUsers, upsertUser, deleteUser, fetchTasks, upsertTask, fetchAttendance } from './supabase.js';

// ======================= Ø§Ù„Ù„ØºØ§Øª =======================
let currentLang='ar';
const texts = {
    ar:{
        header:'Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±',
        switch:'Switch to English',
        nav:{users:'Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', tasks:'Ø§Ù„Ù…Ù‡Ø§Ù…', attendance:'Ø§Ù„Ø­Ø¶ÙˆØ±', reports:'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'},
        users:{title:'Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', add:'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯', role:'Ø§Ù„Ø¯ÙˆØ±', phone:'Ø§Ù„Ù‡Ø§ØªÙ', email:'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', pass:'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', addBtn:'â• Ø¥Ø¶Ø§ÙØ©', current:'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ†', th:{role:'Ø§Ù„Ø¯ÙˆØ±', phone:'Ø§Ù„Ù‡Ø§ØªÙ', email:'Ø§Ù„Ø¨Ø±ÙŠØ¯', pass:'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', actions:'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª'}},
        tasks:{title:'Ø§Ù„Ù…Ù‡Ø§Ù…', emp:'Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨', titleLabel:'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©', desc:'Ø§Ù„ÙˆØµÙ', datetime:'ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª', save:'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©'},
        attendance:{title:'Ø§Ù„Ø­Ø¶ÙˆØ±'},
        reports:{title:'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'}
    },
    en:{
        header:'Manager Dashboard',
        switch:'Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
        nav:{users:'Users', tasks:'Tasks', attendance:'Attendance', reports:'Reports'},
        users:{title:'Users', add:'Add New User', role:'Role', phone:'Phone', email:'Email', pass:'Password', addBtn:'â• Add', current:'Current Users', th:{role:'Role', phone:'Phone', email:'Email', pass:'Password', actions:'Actions'}},
        tasks:{title:'Tasks', emp:'Employee', titleLabel:'Title', desc:'Description', datetime:'Date & Time', save:'ğŸ’¾ Save Task'},
        attendance:{title:'Attendance'},
        reports:{title:'Reports'}
    }
};
function switchLanguage(){
    currentLang=currentLang==='ar'?'en':'ar';
    const t=texts[currentLang];
    document.body.style.direction=currentLang==='ar'?'rtl':'ltr';
    document.getElementById('header-name').innerText=t.header;
    document.getElementById('lang-switch').innerText=t.switch;
    document.getElementById('btn-users').innerText=t.nav.users;
    document.getElementById('btn-tasks').innerText=t.nav.tasks;
    document.getElementById('btn-attendance').innerText=t.nav.attendance;
    document.getElementById('btn-reports').innerText=t.nav.reports;

    document.getElementById('users-title').innerText=t.users.title;
    document.getElementById('add-user-title').innerText=t.users.add;
    document.getElementById('role-label').innerText=t.users.role;
    document.getElementById('phone-label').innerText=t.users.phone;
    document.getElementById('email-label').innerText=t.users.email;
    document.getElementById('pass-label').innerText=t.users.pass;
    document.getElementById('add-btn').innerText=t.users.addBtn;
    document.getElementById('current-users-title').innerText=t.users.current;
    document.getElementById('th-role').innerText=t.users.th.role;
    document.getElementById('th-phone').innerText=t.users.th.phone;
    document.getElementById('th-email').innerText=t.users.th.email;
    document.getElementById('th-pass').innerText=t.users.th.pass;
    document.getElementById('th-actions').innerText=t.users.th.actions;

    document.getElementById('tasks-title').innerText=t.tasks.title;
    document.getElementById('task-emp-label').innerText=t.tasks.emp;
    document.getElementById('task-title-label').innerText=t.tasks.titleLabel;
    document.getElementById('task-desc-label').innerText=t.tasks.desc;
    document.getElementById('task-datetime-label').innerText=t.tasks.datetime;
    document.getElementById('task-save-btn').innerText=t.tasks.save;

    document.getElementById('attendance-title').innerText=t.attendance.title;
    document.getElementById('reports-title').innerText=t.reports.title;
}
document.getElementById('lang-switch').onclick=switchLanguage;

// ======================= Ø§Ù„Ø³Ø§Ø¹Ø© =======================
function updateTime(){ document.getElementById("current-time").innerText = new Date().toLocaleTimeString(); }
setInterval(updateTime,1000); updateTime();

// ======================= Ø§Ù„ØªÙ†Ù‚Ù„ =======================
window.showSection = function(id){
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById('btn-'+id).classList.add('active');
}
showSection('users');

// ======================= Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† =======================
async function loadUsers(){
    try{
        const users=await fetchUsers();
        const tbody=document.querySelector('#users-table tbody'); tbody.innerHTML='';
        users.forEach(u=>{
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${u.role}</td><td>${u.phone}</td><td>${u.email||''}</td><td>${u.password}</td>
            <td>
                <button class="action-btn" onclick="editUser('${u.phone}')">âœï¸</button>
                <button class="action-btn" onclick="removeUser('${u.phone}')">ğŸ—‘ï¸</button>
            </td>`;
            tbody.appendChild(tr);
        });
    }catch(err){ console.error(err); document.getElementById('error-msg').innerText='Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†!'; }
}
window.addUser=async function(){
    const role=document.getElementById('user-role').value;
    const phone=document.getElementById('user-phone').value.trim();
    const email=document.getElementById('user-email').value.trim();
    const pass=document.getElementById('user-pass').value.trim();
    if(!phone||!pass) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‡Ø§ØªÙ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
    await upsertUser({role, phone, email, password:pass});
    document.getElementById('user-phone').value='';
    document.getElementById('user-email').value='';
    document.getElementById('user-pass').value='';
    await loadUsers();
}
window.removeUser=async function(phone){ if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')){ await deleteUser(phone); await loadUsers(); } }
window.editUser=function(phone){
    const rows=Array.from(document.querySelectorAll('#users-table tbody tr'));
    rows.forEach(tr=>{
        if(tr.children[1].innerText===phone){
            document.getElementById('user-role').value=tr.children[0].innerText.includes('Supervisor')?'supervisor':'employee';
            document.getElementById('user-phone').value=tr.children[1].innerText;
            document.getElementById('user-email').value=tr.children[2].innerText;
            document.getElementById('user-pass').value=tr.children[3].innerText;
        }
    });
}

// ======================= Ø§Ù„Ù…Ù‡Ø§Ù… =======================
async function loadEmployees(){
    const users=await fetchUsers();
    const empSelect=document.getElementById('task-employee'); empSelect.innerHTML='';
    users.filter(u=>u.role==='employee').forEach(u=>{
        const opt=document.createElement('option'); opt.value=u.phone; opt.innerText=u.phone;
        empSelect.appendChild(opt);
    });
}
loadEmployees();
window.saveTask=async function(){
    const task={employee:document.getElementById('task-employee').value,
        title:document.getElementById('task-title').value,
        description:document.getElementById('task-desc').value,
        datetime:document.getElementById('task-datetime').value};
    await upsertTask(task); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
}

// ======================= Ø§Ù„Ø­Ø¶ÙˆØ± =======================
async function loadAttendance(){
    const attend=await fetchAttendance();
    const div=document.getElementById('attendance-cards'); div.innerHTML='';
    attend.forEach(a=>{
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`<strong>${a.employee}</strong><br>Ø¯Ø®ÙˆÙ„: ${a.checkin||'-'} - Ø®Ø±ÙˆØ¬: ${a.checkout||'-'}`;
        div.appendChild(card);
    });
}
loadAttendance();

// ======================= Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± =======================
async function loadReports(){
    const tasks=await fetchTasks();
    const ctx=document.getElementById('taskChart').getContext('2d');
    const labels=[...new Set(tasks.map(t=>t.employee))];
    const data=labels.map(l=>tasks.filter(t=>t.employee===l).length);
    new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù…',data,backgroundColor:'#28a745'}]}});
}
loadReports();

// ======================= Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ =======================
loadUsers();

</script>
</body>
</html>
