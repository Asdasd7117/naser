<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± / Manager Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f2f5; direction: rtl;}
header { background:#007bff; color:#fff; padding:15px; display:flex; justify-content:space-between; align-items:center;}
header h1 { margin:0; font-size:18px;}
header .time { font-size:14px;}
.lang-switch { position:absolute; top:15px; right:15px; background:#ffc107; color:#000; border:none; padding:8px; border-radius:6px; cursor:pointer;}
.container { padding:20px; max-width:1200px; margin:auto;}
nav { display:flex; justify-content:space-around; margin-bottom:20px; flex-wrap:wrap;}
nav button { padding:10px 20px; border:none; border-radius:8px; cursor:pointer; background:#28a745; color:#fff; font-weight:bold; margin:5px;}
nav button.active { background:#218838;}
section { display:none; }
section.active { display:block; }
.card { background:#fff; padding:15px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin-bottom:15px;}
table { width:100%; border-collapse: collapse;}
table th, table td { border:1px solid #ccc; padding:8px; text-align:center;}
label { display:block; margin-top:10px;}
input, select, textarea, button { width:100%; padding:8px; margin-top:5px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;}
button.action-btn { width:auto; margin:2px; background:#dc3545; color:#fff; }
</style>
</head>
<body>

<header>
    <h1 id="header-name">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</h1>
    <div class="time" id="current-time">00:00:00</div>
</header>
<button class="lang-switch" onclick="switchLanguage()">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© / Switch Language</button>

<nav>
    <button onclick="showSection('users')" id="btn-users">Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† / Users</button>
    <button onclick="showSection('tasks')" id="btn-tasks">Ø§Ù„Ù…Ù‡Ø§Ù… / Tasks</button>
    <button onclick="showSection('attendance')" id="btn-attendance">Ø§Ù„Ø­Ø¶ÙˆØ± / Attendance</button>
    <button onclick="showSection('reports')" id="btn-reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± / Reports</button>
</nav>

<div class="container">

<!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª -->
<section id="users">
    <h2>Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† / Users</h2>
    <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ / Add User</h3>
    <label>Ø§Ù„Ø¯ÙˆØ± / Role</label>
    <select id="user-role">
        <option value="supervisor">Ù…Ø´Ø±Ù / Supervisor</option>
        <option value="employee">Ù…Ù†Ø¯ÙˆØ¨ / Employee</option>
    </select>
    <label>Ø§Ù„Ù‡Ø§ØªÙ / Phone</label>
    <input type="text" id="user-phone">
    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ / Email</label>
    <input type="text" id="user-email">
    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± / Password</label>
    <input type="text" id="user-pass">
    <button onclick="addUser()">â• Ø¥Ø¶Ø§ÙØ© / Add</button>

    <h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ† / Current Users</h3>
    <table id="users-table">
        <thead><tr><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
        <tbody></tbody>
    </table>
</section>

<!-- Ø§Ù„Ù…Ù‡Ø§Ù… -->
<section id="tasks">
    <h2>Ø§Ù„Ù…Ù‡Ø§Ù… / Tasks</h2>
    <label>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ / Employee</label>
    <select id="task-employee"></select>
    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø© / Title</label>
    <input type="text" id="task-title">
    <label>Ø§Ù„ÙˆØµÙ / Description</label>
    <textarea id="task-desc"></textarea>
    <label>ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª / Date & Time</label>
    <input type="datetime-local" id="task-datetime">
    <button onclick="saveTask()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø© / Save Task</button>
</section>

<!-- Ø§Ù„Ø­Ø¶ÙˆØ± -->
<section id="attendance">
    <h2>Ø§Ù„Ø­Ø¶ÙˆØ± / Attendance</h2>
    <div id="attendance-cards"></div>
</section>

<!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
<section id="reports">
    <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± / Reports</h2>
    <canvas id="taskChart" style="max-height:300px;"></canvas>
</section>

</div>

<script type="module">
import { fetchUsers, upsertUser, deleteUser, fetchTasks, upsertTask, fetchAttendance } from './supabase.js';

// Ø§Ù„Ù„ØºØ©
let currentLang = 'ar';
window.switchLanguage = function(){
    currentLang = currentLang==='ar' ? 'en' : 'ar';
    document.body.style.direction = currentLang==='ar' ? 'rtl' : 'ltr';
}

// Ø§Ù„Ø³Ø§Ø¹Ø©
function updateTime(){
    const now = new Date(new Date().toLocaleString("en-US",{timeZone:"Africa/Cairo"}));
    document.getElementById("current-time").innerText = now.toLocaleTimeString();
}
setInterval(updateTime,1000); updateTime();

// Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
window.showSection = function(id){
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById('btn-'+id).classList.add('active');
}
showSection('users');

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
async function loadUsers(){
    const users = await fetchUsers();
    const tbody = document.querySelector('#users-table tbody');
    tbody.innerHTML='';
    users.forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML=`<td>${u.role}</td><td>${u.phone}</td><td>${u.email||''}</td><td>${u.password}</td>
        <td>
            <button class="action-btn" onclick="editUser('${u.phone}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="action-btn" onclick="removeUser('${u.phone}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </td>`;
        tbody.appendChild(tr);
    });
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù„Ù‰ window
window.addUser = async function(){
    const role=document.getElementById('user-role').value;
    const phone=document.getElementById('user-phone').value.trim();
    const email=document.getElementById('user-email').value.trim();
    const pass=document.getElementById('user-pass').value.trim();
    if(!phone||!pass) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‡Ø§ØªÙ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± / Enter phone & password');
    await upsertUser({role, phone, email, password:pass});
    document.getElementById('user-phone').value='';
    document.getElementById('user-email').value='';
    document.getElementById('user-pass').value='';
    loadUsers();
}

window.removeUser = async function(phone){
    if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ / Delete?')){
        await deleteUser(phone); loadUsers();
    }
}

window.editUser = function(phone){
    const rows = Array.from(document.querySelectorAll('#users-table tbody tr'));
    rows.forEach(tr=>{
        if(tr.children[1].innerText===phone){
            document.getElementById('user-role').value=tr.children[0].innerText.includes('Supervisor')?'supervisor':'employee';
            document.getElementById('user-phone').value=tr.children[1].innerText;
            document.getElementById('user-email').value=tr.children[2].innerText;
            document.getElementById('user-pass').value=tr.children[3].innerText;
        }
    });
}

// Ø§Ù„Ù…Ù‡Ø§Ù…
async function loadEmployees(){
    const users = await fetchUsers();
    const empSelect = document.getElementById('task-employee');
    empSelect.innerHTML='';
    users.filter(u=>u.role==='employee').forEach(u=>{
        const opt=document.createElement('option');
        opt.value=u.phone; opt.innerText=u.phone;
        empSelect.appendChild(opt);
    });
}
loadEmployees();

window.saveTask = async function(){
    const task={employee:document.getElementById('task-employee').value,title:document.getElementById('task-title').value,
        description:document.getElementById('task-desc').value,datetime:document.getElementById('task-datetime').value};
    await upsertTask(task);
    alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ / Saved');
}

// Ø§Ù„Ø­Ø¶ÙˆØ±
async function loadAttendance(){
    const attend = await fetchAttendance();
    const div=document.getElementById('attendance-cards'); div.innerHTML='';
    attend.forEach(a=>{
        const card = document.createElement('div'); card.className='card';
        card.innerHTML=`<strong>${a.employee}</strong><br>Ø¯Ø®ÙˆÙ„: ${a.checkin||'-'} - Ø®Ø±ÙˆØ¬: ${a.checkout||'-'}`;
        div.appendChild(card);
    });
}
loadAttendance();

// Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
async function loadReports(){
    const tasks = await fetchTasks();
    const ctx = document.getElementById('taskChart').getContext('2d');
    const labels = [...new Set(tasks.map(t=>t.employee))];
    const data = labels.map(l=>tasks.filter(t=>t.employee===l).length);
    new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù…',data,backgroundColor:'#28a745'}]}});
}
loadReports();

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
loadUsers();

</script>
</body>
</html>
