<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>شاشة المدير</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    nav {
      display: flex;
      justify-content: space-around;
      background: #2196f3;
      padding: 10px;
      color: white;
    }
    nav button {
      background: transparent;
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    section { display: none; padding: 20px; }
    section.active { display: block; }
    .card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }
    .delete-btn { color: red; cursor: pointer; margin-left: 10px; }
  </style>
</head>
<body>
  <nav>
    <button onclick="showTab('reports')">📊 التقارير</button>
    <button onclick="showTab('attendance')">⏰ الحضور</button>
    <button onclick="showTab('control')">⚙️ لوحة التحكم</button>
  </nav>

  <!-- ===== التقارير ===== -->
  <section id="reports" class="active">
    <h2>📊 التقارير والتحليلات</h2>
    <canvas id="generalChart" width="400" height="200"></canvas>

    <h3>📈 أداء المندوبين</h3>
    <div id="employeesPerformance"></div>
  </section>

  <!-- ===== الحضور والانصراف ===== -->
  <section id="attendance">
    <h2>⏰ الحضور والانصراف</h2>
    <div id="attendanceList"></div>
  </section>

  <!-- ===== لوحة التحكم ===== -->
  <section id="control">
    <h2>👥 إدارة المستخدمين</h2>
    <form id="addUserForm">
      <input type="text" id="name" placeholder="الاسم الكامل" required>
      <input type="text" id="email" placeholder="البريد الإلكتروني">
      <input type="text" id="phone" placeholder="رقم الهاتف">
      <input type="password" id="password" placeholder="كلمة المرور" required>
      <select id="role" required>
        <option value="">اختر الدور</option>
        <option value="employee">مندوب</option>
        <option value="supervisor">مشرف</option>
      </select>
      <button type="submit">➕ إضافة مستخدم</button>
    </form>
    <div id="usersList"></div>

    <h2>📝 إدارة المهام</h2>
    <form id="addTaskForm">
      <select id="employeeSelect" required></select>
      <input type="text" id="client_name" placeholder="اسم العميل" required>
      <input type="text" id="address" placeholder="العنوان" required>
      <input type="datetime-local" id="visit_time" required>
      <button type="submit">➕ إضافة مهمة</button>
    </form>
    <div id="tasksList"></div>

    <h2>📢 إرسال إشعارات</h2>
    <form id="notifyForm">
      <textarea id="message" placeholder="نص الإشعار" required></textarea>
      <button type="submit">📨 إرسال إشعار جماعي</button>
    </form>
  </section>

  <script>
    function showTab(id) {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    // ===== التقارير =====
    async function loadReports() {
      const res = await fetch("/tasks");
      const tasks = await res.json();

      const completed = tasks.filter(t => t.status === "completed").length;
      const in_progress = tasks.filter(t => t.status === "in_progress").length;
      const delayed = tasks.filter(t => t.status === "delayed").length;

      new Chart(document.getElementById("generalChart"), {
        type: "doughnut",
        data: {
          labels: ["مكتملة", "قيد التنفيذ", "مؤجلة"],
          datasets: [{
            data: [completed, in_progress, delayed],
            backgroundColor: ["#4caf50", "#2196f3", "#f44336"]
          }]
        }
      });

      const perfContainer = document.getElementById("employeesPerformance");
      perfContainer.innerHTML = "";
      const grouped = {};
      tasks.forEach(t => {
        if (!grouped[t.employee_id]) grouped[t.employee_id] = { completed: 0, total: 0 };
        grouped[t.employee_id].total++;
        if (t.status === "completed") grouped[t.employee_id].completed++;
      });
      for (let emp in grouped) {
        const p = Math.round((grouped[emp].completed / grouped[emp].total) * 100);
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<strong>مندوب ID ${emp}</strong> - نسبة الإنجاز: ${p}%`;
        perfContainer.appendChild(div);
      }
    }

    // ===== الحضور =====
    async function loadAttendance() {
      const res = await fetch("/attendance");
      const data = await res.json();
      const container = document.getElementById("attendanceList");
      container.innerHTML = "";
      data.forEach(a => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <strong>${a.user_name}</strong><br>
          دخول: ${a.check_in} - خروج: ${a.check_out || "لم يسجل خروج"}
        `;
        container.appendChild(div);
      });
    }

    // ===== إدارة المستخدمين =====
    document.getElementById("addUserForm").addEventListener("submit", async e => {
      e.preventDefault();
      const payload = {
        name_ar: document.getElementById("name").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
        password: document.getElementById("password").value,
        role: document.getElementById("role").value
      };
      const res = await fetch("/add-user", {
        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
      });
      if (res.ok) { alert("تم إضافة المستخدم"); loadUsers(); loadEmployees(); }
    });

    async function loadUsers() {
      const res = await fetch("/users");
      const users = await res.json();
      const container = document.getElementById("usersList");
      container.innerHTML = "";
      users.forEach(u => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          ${u.name_ar} | ${u.role} | ${u.email || u.phone}
          <span class="delete-btn" onclick="deleteUser(${u.id})">🗑 حذف</span>
        `;
        container.appendChild(div);
      });
    }

    async function deleteUser(id) {
      if (!confirm("هل تريد حذف هذا المستخدم؟")) return;
      const res = await fetch(`/users/${id}`, { method: "DELETE" });
      if (res.ok) { alert("تم حذف المستخدم"); loadUsers(); loadEmployees(); loadTasks(); }
    }

    async function loadEmployees() {
      const res = await fetch("/users");
      const users = await res.json();
      const select = document.getElementById("employeeSelect");
      select.innerHTML = "<option value=''>اختر المندوب</option>";
      users.filter(u => u.role === "employee").forEach(u => {
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = u.name_ar;
        select.appendChild(opt);
      });
    }

    // ===== إدارة المهام =====
    document.getElementById("addTaskForm").addEventListener("submit", async e => {
      e.preventDefault();
      const payload = {
        employee_id: document.getElementById("employeeSelect").value,
        client_name_ar: document.getElementById("client_name").value,
        address_ar: document.getElementById("address").value,
        visit_time: document.getElementById("visit_time").value
      };
      const res = await fetch("/tasks", {
        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
      });
      if (res.ok) { alert("تمت إضافة المهمة"); loadTasks(); }
    });

    async function loadTasks() {
      const res = await fetch("/tasks");
      const tasks = await res.json();
      const container = document.getElementById("tasksList");
      container.innerHTML = "";
      tasks.forEach(t => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <strong>${t.client_name_ar}</strong> - الحالة: ${t.status || "جديدة"}
          <span class="delete-btn" onclick="deleteTask(${t.id})">🗑 حذف</span>
        `;
        container.appendChild(div);
      });
    }

    async function deleteTask(id) {
      if (!confirm("هل تريد حذف هذه المهمة؟")) return;
      const res = await fetch(`/tasks/${id}`, { method: "DELETE" });
      if (res.ok) { alert("تم حذف المهمة"); loadTasks(); loadReports(); }
    }

    // ===== إرسال إشعارات =====
    document.getElementById("notifyForm").addEventListener("submit", async e => {
      e.preventDefault();
      const message = document.getElementById("message").value;
      // جلب كل المستخدمين لإرسال الإشعار لهم
      const resUsers = await fetch("/users");
      const users = await resUsers.json();
      for (let u of users) {
        await fetch("/notifications", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: u.id,
            title_ar: "إشعار من المدير",
            title_en: "Manager Notification",
            message_ar: message,
            message_en: message,
            type: "individual"
          })
        });
      }
      alert("✅ تم إرسال الإشعارات لجميع المستخدمين");
    });

    // ===== تحميل الكل =====
    loadReports();
    loadAttendance();
    loadUsers();
    loadEmployees();
    loadTasks();
  </script>
</body>
</html>
