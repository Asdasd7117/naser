<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>لوحة المدير</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f2f5; direction: rtl;}
header { background:#007bff; color:#fff; padding:15px; display:flex; justify-content:space-between; align-items:center;}
header h1 { margin:0; font-size:18px;}
header .time { font-size:14px;}
.lang-switch { position:absolute; top:15px; right:15px; background:#ffc107; color:#000; border:none; padding:8px; border-radius:6px; cursor:pointer;}
.container { padding:20px; max-width:1200px; margin:auto;}
nav { display:flex; justify-content:space-around; margin-bottom:20px; flex-wrap:wrap;}
nav button { padding:10px 20px; border:none; border-radius:8px; cursor:pointer; background:#28a745; color:#fff; font-weight:bold; margin:5px;}
nav button.active { background:#218838;}
section { display:none; }
section.active { display:block; }
.card { background:#fff; padding:15px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin-bottom:15px;}
table { width:100%; border-collapse: collapse;}
table th, table td { border:1px solid #ccc; padding:8px; text-align:center;}
label { display:block; margin-top:10px;}
input, select, textarea, button { width:100%; padding:8px; margin-top:5px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;}
button.action-btn { width:auto; margin:2px; background:#dc3545; color:#fff; }
.error-msg { color:red; font-weight:bold; margin:10px 0; }
</style>
</head>
<body>

<header>
    <h1 id="header-name">لوحة المدير</h1>
    <div class="time" id="current-time">00:00:00</div>
</header>
<button class="lang-switch" id="lang-switch">Switch Language</button>

<nav>
    <button onclick="showSection('users')" id="btn-users">حسابات المستخدمين</button>
    <button onclick="showSection('tasks')" id="btn-tasks">المهام</button>
    <button onclick="showSection('attendance')" id="btn-attendance">الحضور</button>
    <button onclick="showSection('reports')" id="btn-reports">التقارير</button>
</nav>

<div class="container">
<div id="error-msg" class="error-msg"></div>

<section id="users">
    <h2 id="users-title">حسابات المستخدمين</h2>
    <h3 id="add-user-title">إضافة مستخدم جديد</h3>
    <label id="role-label">الدور</label>
    <select id="user-role">
        <option value="supervisor">مشرف</option>
        <option value="employee">مندوب</option>
    </select>
    <label id="phone-label">الهاتف</label>
    <input type="text" id="user-phone">
    <label id="email-label">البريد الإلكتروني</label>
    <input type="text" id="user-email">
    <label id="pass-label">كلمة المرور</label>
    <input type="text" id="user-pass">
    <button onclick="addUser()" id="add-btn">➕ إضافة</button>

    <h3 id="current-users-title">المستخدمون الحاليون</h3>
    <table id="users-table">
        <thead>
            <tr>
                <th id="th-role">الدور</th>
                <th id="th-phone">الهاتف</th>
                <th id="th-email">البريد</th>
                <th id="th-pass">كلمة المرور</th>
                <th id="th-actions">إجراءات</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</section>

<section id="tasks">
    <h2 id="tasks-title">المهام</h2>
    <label id="task-emp-label">المندوب</label>
    <select id="task-employee"></select>
    <label id="task-title-label">عنوان المهمة</label>
    <input type="text" id="task-title">
    <label id="task-desc-label">الوصف</label>
    <textarea id="task-desc"></textarea>
    <label id="task-datetime-label">تاريخ ووقت</label>
    <input type="datetime-local" id="task-datetime">
    <button onclick="saveTask()" id="task-save-btn">💾 حفظ المهمة</button>
</section>

<section id="attendance">
    <h2 id="attendance-title">الحضور</h2>
    <div id="attendance-cards"></div>
</section>

<section id="reports">
    <h2 id="reports-title">التقارير</h2>
    <canvas id="taskChart" style="max-height:300px;"></canvas>
</section>

</div>

<script type="module">
import { fetchUsers, upsertUser, deleteUser, fetchTasks, upsertTask, fetchAttendance } from './supabase.js';

// ======================= اللغات =======================
let currentLang='ar';
const texts = {
    ar:{
        header:'لوحة المدير',
        switch:'Switch to English',
        nav:{users:'حسابات المستخدمين', tasks:'المهام', attendance:'الحضور', reports:'التقارير'},
        users:{title:'حسابات المستخدمين', add:'إضافة مستخدم جديد', role:'الدور', phone:'الهاتف', email:'البريد الإلكتروني', pass:'كلمة المرور', addBtn:'➕ إضافة', current:'المستخدمون الحاليون', th:{role:'الدور', phone:'الهاتف', email:'البريد', pass:'كلمة المرور', actions:'إجراءات'}},
        tasks:{title:'المهام', emp:'المندوب', titleLabel:'عنوان المهمة', desc:'الوصف', datetime:'تاريخ ووقت', save:'💾 حفظ المهمة'},
        attendance:{title:'الحضور'},
        reports:{title:'التقارير'}
    },
    en:{
        header:'Manager Dashboard',
        switch:'التبديل إلى العربية',
        nav:{users:'Users', tasks:'Tasks', attendance:'Attendance', reports:'Reports'},
        users:{title:'Users', add:'Add New User', role:'Role', phone:'Phone', email:'Email', pass:'Password', addBtn:'➕ Add', current:'Current Users', th:{role:'Role', phone:'Phone', email:'Email', pass:'Password', actions:'Actions'}},
        tasks:{title:'Tasks', emp:'Employee', titleLabel:'Title', desc:'Description', datetime:'Date & Time', save:'💾 Save Task'},
        attendance:{title:'Attendance'},
        reports:{title:'Reports'}
    }
};
function switchLanguage(){
    currentLang=currentLang==='ar'?'en':'ar';
    const t=texts[currentLang];
    document.body.style.direction=currentLang==='ar'?'rtl':'ltr';
    document.getElementById('header-name').innerText=t.header;
    document.getElementById('lang-switch').innerText=t.switch;
    document.getElementById('btn-users').innerText=t.nav.users;
    document.getElementById('btn-tasks').innerText=t.nav.tasks;
    document.getElementById('btn-attendance').innerText=t.nav.attendance;
    document.getElementById('btn-reports').innerText=t.nav.reports;

    document.getElementById('users-title').innerText=t.users.title;
    document.getElementById('add-user-title').innerText=t.users.add;
    document.getElementById('role-label').innerText=t.users.role;
    document.getElementById('phone-label').innerText=t.users.phone;
    document.getElementById('email-label').innerText=t.users.email;
    document.getElementById('pass-label').innerText=t.users.pass;
    document.getElementById('add-btn').innerText=t.users.addBtn;
    document.getElementById('current-users-title').innerText=t.users.current;
    document.getElementById('th-role').innerText=t.users.th.role;
    document.getElementById('th-phone').innerText=t.users.th.phone;
    document.getElementById('th-email').innerText=t.users.th.email;
    document.getElementById('th-pass').innerText=t.users.th.pass;
    document.getElementById('th-actions').innerText=t.users.th.actions;

    document.getElementById('tasks-title').innerText=t.tasks.title;
    document.getElementById('task-emp-label').innerText=t.tasks.emp;
    document.getElementById('task-title-label').innerText=t.tasks.titleLabel;
    document.getElementById('task-desc-label').innerText=t.tasks.desc;
    document.getElementById('task-datetime-label').innerText=t.tasks.datetime;
    document.getElementById('task-save-btn').innerText=t.tasks.save;

    document.getElementById('attendance-title').innerText=t.attendance.title;
    document.getElementById('reports-title').innerText=t.reports.title;
}
document.getElementById('lang-switch').onclick=switchLanguage;

// ======================= الساعة =======================
function updateTime(){ document.getElementById("current-time").innerText = new Date().toLocaleTimeString(); }
setInterval(updateTime,1000); updateTime();

// ======================= التنقل =======================
window.showSection = function(id){
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById('btn-'+id).classList.add('active');
}
showSection('users');

// ======================= المستخدمون =======================
async function loadUsers(){
    try{
        const users=await fetchUsers();
        const tbody=document.querySelector('#users-table tbody'); tbody.innerHTML='';
        users.forEach(u=>{
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${u.role}</td><td>${u.phone}</td><td>${u.email||''}</td><td>${u.password}</td>
            <td>
                <button class="action-btn" onclick="editUser('${u.phone}')">✏️</button>
                <button class="action-btn" onclick="removeUser('${u.phone}')">🗑️</button>
            </td>`;
            tbody.appendChild(tr);
        });
    }catch(err){ console.error(err); document.getElementById('error-msg').innerText='خطأ في جلب المستخدمين!'; }
}
window.addUser=async function(){
    const role=document.getElementById('user-role').value;
    const phone=document.getElementById('user-phone').value.trim();
    const email=document.getElementById('user-email').value.trim();
    const pass=document.getElementById('user-pass').value.trim();
    if(!phone||!pass) return alert('أدخل الهاتف وكلمة المرور');
    await upsertUser({role, phone, email, password:pass});
    document.getElementById('user-phone').value='';
    document.getElementById('user-email').value='';
    document.getElementById('user-pass').value='';
    await loadUsers();
}
window.removeUser=async function(phone){ if(confirm('هل تريد الحذف؟')){ await deleteUser(phone); await loadUsers(); } }
window.editUser=function(phone){
    const rows=Array.from(document.querySelectorAll('#users-table tbody tr'));
    rows.forEach(tr=>{
        if(tr.children[1].innerText===phone){
            document.getElementById('user-role').value=tr.children[0].innerText.includes('Supervisor')?'supervisor':'employee';
            document.getElementById('user-phone').value=tr.children[1].innerText;
            document.getElementById('user-email').value=tr.children[2].innerText;
            document.getElementById('user-pass').value=tr.children[3].innerText;
        }
    });
}

// ======================= المهام =======================
async function loadEmployees(){
    const users=await fetchUsers();
    const empSelect=document.getElementById('task-employee'); empSelect.innerHTML='';
    users.filter(u=>u.role==='employee').forEach(u=>{
        const opt=document.createElement('option'); opt.value=u.phone; opt.innerText=u.phone;
        empSelect.appendChild(opt);
    });
}
loadEmployees();
window.saveTask=async function(){
    const task={employee:document.getElementById('task-employee').value,
        title:document.getElementById('task-title').value,
        description:document.getElementById('task-desc').value,
        datetime:document.getElementById('task-datetime').value};
    await upsertTask(task); alert('تم الحفظ');
}

// ======================= الحضور =======================
async function loadAttendance(){
    const attend=await fetchAttendance();
    const div=document.getElementById('attendance-cards'); div.innerHTML='';
    attend.forEach(a=>{
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`<strong>${a.employee}</strong><br>دخول: ${a.checkin||'-'} - خروج: ${a.checkout||'-'}`;
        div.appendChild(card);
    });
}
loadAttendance();

// ======================= التقارير =======================
async function loadReports(){
    const tasks=await fetchTasks();
    const ctx=document.getElementById('taskChart').getContext('2d');
    const labels=[...new Set(tasks.map(t=>t.employee))];
    const data=labels.map(l=>tasks.filter(t=>t.employee===l).length);
    new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'عدد المهام',data,backgroundColor:'#28a745'}]}});
}
loadReports();

// ======================= بدء التشغيل =======================
loadUsers();

</script>
</body>
</html>
