<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>المدير</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>📊 إحصائيات المهام</h2>
  <canvas id="statsChart" width="400" height="200"></canvas>

  <section>
    <h2>👥 إضافة مستخدم جديد</h2>
    <form id="addUserForm">
      <input type="text" id="name" placeholder="الاسم الكامل" required>
      <input type="text" id="email" placeholder="البريد الإلكتروني">
      <input type="text" id="phone" placeholder="رقم الهاتف">
      <input type="password" id="password" placeholder="كلمة المرور" required>
      <select id="role" required>
        <option value="">اختر الدور</option>
        <option value="employee">مندوب</option>
        <option value="supervisor">مشرف</option>
      </select>
      <button type="submit">➕ إضافة مستخدم</button>
    </form>

    <h3>قائمة المستخدمين</h3>
    <div id="usersList"></div>
  </section>

  <section>
    <h2>➕ إضافة مهمة جديدة</h2>
    <form id="addTaskForm">
      <select id="employeeSelect" required>
        <option value="">اختر المندوب</option>
      </select>
      <input type="text" id="client_name" placeholder="اسم العميل" required>
      <input type="text" id="address" placeholder="العنوان" required>
      <input type="datetime-local" id="visit_time" required>
      <button type="submit">إضافة مهمة</button>
    </form>

    <h3>قائمة المهام</h3>
    <div id="tasksList"></div>
  </section>

  <script>
    // ===== تحميل الإحصائيات =====
    async function loadStats() {
      try {
        const res = await fetch("/tasks");
        const tasks = await res.json();

        const completed = tasks.filter(t => t.status === "completed").length;
        const in_progress = tasks.filter(t => t.status === "in_progress").length;
        const delayed = tasks.filter(t => t.status === "delayed").length;

        new Chart(document.getElementById("statsChart"), {
          type: "doughnut",
          data: {
            labels: ["مكتملة", "قيد التنفيذ", "مؤجلة"],
            datasets: [{
              data: [completed, in_progress, delayed],
              backgroundColor: ["#4caf50", "#2196f3", "#f44336"]
            }]
          }
        });
      } catch (err) {
        console.error(err);
      }
    }

    // ===== إضافة مستخدم =====
    document.getElementById("addUserForm").addEventListener("submit", async e => {
      e.preventDefault();
      const name = document.getElementById("name").value;
      const email = document.getElementById("email").value;
      const phone = document.getElementById("phone").value;
      const password = document.getElementById("password").value;
      const role = document.getElementById("role").value;

      try {
        const res = await fetch("/add-user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            name_ar: name, 
            name_en: name, 
            email, 
            phone, 
            password, 
            role 
          })
        });

        const data = await res.json();
        if (res.ok) {
          alert("✅ تم إضافة المستخدم بنجاح");
          loadUsers();
          loadEmployees();
        } else {
          alert("❌ خطأ: " + (data.error || "حدث خطأ"));
        }
      } catch (err) {
        alert("❌ حدث خطأ أثناء الإضافة");
        console.error(err);
      }
    });

    // ===== عرض المستخدمين =====
    async function loadUsers() {
      try {
        const res = await fetch("/users");
        const users = await res.json();
        const container = document.getElementById("usersList");
        container.innerHTML = "";

        users.forEach(u => {
          const div = document.createElement("div");
          div.style.border = "1px solid #ccc";
          div.style.padding = "8px";
          div.style.marginBottom = "5px";
          div.innerHTML = `
            <strong>${u.name_ar}</strong> | ${u.role} | ${u.email || u.phone}
            <button onclick="deleteUser(${u.id})" style="margin-left:10px;color:red;">حذف</button>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        console.error(err);
      }
    }

    async function deleteUser(userId) {
      if (!confirm("هل أنت متأكد من حذف هذا المستخدم؟")) return;
      const res = await fetch(`/users/${userId}`, { method: "DELETE" });
      if (res.ok) loadUsers();
      else alert("❌ حدث خطأ عند الحذف");
    }

    // ===== تحميل المندوبين للقائمة =====
    async function loadEmployees() {
      try {
        const res = await fetch("/users");
        const users = await res.json();
        const select = document.getElementById("employeeSelect");
        select.innerHTML = '<option value="">اختر المندوب</option>';
        users.filter(u => u.role === "employee").forEach(u => {
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = u.name_ar;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // ===== إضافة مهمة جديدة =====
    document.getElementById("addTaskForm").addEventListener("submit", async e => {
      e.preventDefault();
      const employee_id = document.getElementById("employeeSelect").value;
      const client_name = document.getElementById("client_name").value;
      const address = document.getElementById("address").value;
      const visit_time = document.getElementById("visit_time").value;

      try {
        const res = await fetch("/tasks", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            employee_id, 
            client_name_ar: client_name, 
            client_name_en: client_name, 
            address_ar: address, 
            address_en: address, 
            visit_time 
          })
        });

        const data = await res.json();
        if (res.ok) {
          alert("✅ تم إضافة المهمة");
          loadTasks();
        } else {
          alert("❌ خطأ عند إضافة المهمة: " + (data.error || "حدث خطأ"));
        }
      } catch (err) {
        alert("❌ حدث خطأ أثناء إضافة المهمة");
        console.error(err);
      }
    });

    // ===== عرض المهام =====
    async function loadTasks() {
      try {
        const res = await fetch("/tasks");
        const tasks = await res.json();
        const container = document.getElementById("tasksList");
        container.innerHTML = "";

        tasks.forEach(task => {
          const div = document.createElement("div");
          div.style.border = "1px solid #ccc";
          div.style.padding = "8px";
          div.style.marginBottom = "5px";
          div.innerHTML = `
            <strong>مندوب:</strong> ${task.users?.name_ar || task.employee_id} |
            <strong>العميل:</strong> ${task.client_name_ar} |
            <strong>الحالة:</strong> ${task.status || 'جديدة'}
            <button onclick="deleteTask(${task.id})" style="color:red;">حذف</button>
            <button onclick="updateTaskStatus(${task.id}, 'completed')">تمت</button>
            <button onclick="updateTaskStatus(${task.id}, 'in_progress')">قيد التنفيذ</button>
            <button onclick="updateTaskStatus(${task.id}, 'delayed')">مؤجلة</button>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        console.error(err);
      }
    }

    async function deleteTask(taskId) {
      if (!confirm("هل تريد حذف هذه المهمة؟")) return;
      const res = await fetch(`/tasks/${taskId}`, { method: "DELETE" });
      if (res.ok) loadTasks();
      else alert("❌ خطأ عند الحذف");
    }

    async function updateTaskStatus(taskId, status) {
      try {
        await fetch(`/tasks/${taskId}/status`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status })
        });
        loadTasks();
      } catch (err) {
        console.error(err);
      }
    }

    // ===== تحميل كل شيء عند فتح الصفحة =====
    loadStats();
    loadUsers();
    loadEmployees();
    loadTasks();
  </script>
</body>
</html>
