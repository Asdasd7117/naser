<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المشرف</title>
<style>
body { font-family: Arial; margin:0; padding:0; background:#e0f7fa; }
.container { max-width:1200px; margin:20px auto; padding:20px; }
h2 { text-align:center; color:#0277bd; }
section { margin-bottom:30px; padding:15px; background:#fff; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
table { width:100%; border-collapse: collapse; margin-top:10px; }
table, th, td { border:1px solid #ccc; }
th, td { padding:8px; text-align:center; }
input, select { padding:8px; margin:5px 0; border-radius:6px; border:1px solid #ccc; }
img { max-width:150px; max-height:150px; border-radius:6px; }
.map-container { margin-top:10px; margin-bottom:20px; }
.map-wrapper { display:flex; align-items:center; gap:15px; margin-bottom:20px; }
.map-wrapper h4 { width:150px; margin:0; }
.map-wrapper #map { height:200px; flex:1; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
<div class="container">
  <h2>لوحة المشرف</h2>

  <!-- تصفية المهام -->
  <section>
    <h3>المهام لجميع المندوبين</h3>
    <label>اختر المندوب:
      <select id="filterAgent"><option value="">الكل</option></select>
    </label>
    <label>اختر الحالة:
      <select id="filterStatus">
        <option value="">الكل</option>
        <option value="pending">قيد التنفيذ</option>
        <option value="completed">مكتملة</option>
        <option value="delayed">مؤجلة</option>
      </select>
    </label>
    <table>
      <thead>
        <tr>
          <th>المندوب</th>
          <th>العميل</th>
          <th>العنوان</th>
          <th>الوقت</th>
          <th>الحالة</th>
        </tr>
      </thead>
      <tbody id="tasksTableBody"></tbody>
    </table>
  </section>

  <!-- التقارير -->
  <section>
    <h3>تقارير المندوبين</h3>
    <table>
      <thead>
        <tr>
          <th>المندوب</th>
          <th>المهمة</th>
          <th>التقرير</th>
          <th>الصورة</th>
          <th>تاريخ الرفع</th>
        </tr>
      </thead>
      <tbody id="reportsTableBody"></tbody>
    </table>
  </section>

  <!-- الإشعارات -->
  <section>
    <h3>الإشعارات الواردة من المدير</h3>
    <ul id="notificationsList"></ul>
  </section>

  <!-- خريطة كل مندوب -->
  <section>
    <h3>خرائط المناديب</h3>
    <div id="mapsContainer" class="map-container"></div>
  </section>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
import * as L from 'https://unpkg.com/leaflet/dist/leaflet.js';

const supabaseUrl = "https://vkativialsvvbifhjrey.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrYXRpdmlhbHN2dmJpZmhqcmV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMDMxMDUsImV4cCI6MjA3MzY3OTEwNX0.iC-gq-uuXnK_1cJ_gYcjig8sr-bQfhqPk0SnuqbAeL0";
const supabase = createClient(supabaseUrl, supabaseKey);

// تحميل قائمة المندوبين للتصفية والخريطة
async function loadAgents() {
  const { data: agents } = await supabase.from('users').select('*').eq('role','agent');
  const select = document.getElementById('filterAgent');
  agents.forEach(a=>{
    const opt = document.createElement('option');
    opt.value=a.id; opt.text=a.email_or_phone||a.email;
    select.appendChild(opt);
  });
  return agents;
}

// تحميل المهام
async function loadTasks(agents){
  const agentFilter = document.getElementById('filterAgent').value;
  const statusFilter = document.getElementById('filterStatus').value;

  let query = supabase.from('tasks').select('*');
  if(agentFilter) query = query.eq('assigned_to', agentFilter);
  if(statusFilter) query = query.eq('status', statusFilter);

  const { data: tasks } = await query;

  const tbody = document.getElementById('tasksTableBody');
  tbody.innerHTML='';
  tasks.forEach(t=>{
    const agent = agents.find(a=>a.id===t.assigned_to);
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${agent?.email_or_phone||agent?.email||'-'}</td><td>${t.client_name||'-'}</td><td>${t.client_address||'-'}</td><td>${t.visit_time||'-'}</td><td>${t.status||'-'}</td>`;
    tbody.appendChild(tr);
  });
}

// تحميل التقارير
async function loadReports(agents){
  const { data: reports } = await supabase.from('reports').select('*');
  const { data: tasks } = await supabase.from('tasks').select('*');

  const tbody = document.getElementById('reportsTableBody');
  tbody.innerHTML='';
  reports.forEach(r=>{
    const agent = agents.find(a=>a.id===r.agent_id);
    const task = tasks.find(t=>t.id===r.task_id);
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${agent?.email_or_phone||agent?.email||'-'}</td><td>${task?.client_name||'-'}</td><td>${r.report_text||'-'}</td><td>${r.image_url ? `<img src="${r.image_url}">`:'-'}</td><td>${r.created_at||'-'}</td>`;
    tbody.appendChild(tr);
  });
}

// تحميل الإشعارات
async function loadNotifications(agents){
  const { data: notifications } = await supabase.from('notifications').select('*');
  const ul = document.getElementById('notificationsList');
  ul.innerHTML='';
  notifications.forEach(n=>{
    const agent = agents.find(a=>a.id===n.user_id||a.id===n.assigned_to);
    if(agent){
      const li = document.createElement('li');
      li.textContent = `[${agent.email_or_phone||agent.email}] ${n.message||n.msg||n.text||'-'}`;
      ul.appendChild(li);
    }
  });
}

// تحميل خرائط المناديب
async function loadMaps(agents){
  const container = document.getElementById('mapsContainer');
  container.innerHTML='';
  agents.forEach(a=>{
    const wrapper = document.createElement('div');
    wrapper.className = 'map-wrapper';
    const title = document.createElement('h4');
    title.textContent = a.email_or_phone||a.email||'-';
    const mapDiv = document.createElement('div');
    mapDiv.id = 'map_'+a.id;
    mapDiv.style.height = '200px';
    mapDiv.style.flex = '1';
    wrapper.appendChild(title);
    wrapper.appendChild(mapDiv);
    container.appendChild(wrapper);

    // إنشاء الخريطة
    const map = L.map(mapDiv.id).setView([30.0444,31.2357],10); // القاهرة افتراضياً
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);
    // مثال: علامة افتراضية
    L.marker([30.0444,31.2357]).addTo(map).bindPopup(a.email_or_phone||a.email);
  });
}

// التصفية عند تغيير الاختيار
document.getElementById('filterAgent').addEventListener('change', async ()=>{
  const agents = await loadAgents();
  await loadTasks(agents);
});
document.getElementById('filterStatus').addEventListener('change', async ()=>{
  const agents = await loadAgents();
  await loadTasks(agents);
});

// تحميل كل البيانات عند البداية
(async()=>{
  const agents = await loadAgents();
  await loadTasks(agents);
  await loadReports(agents);
  await loadNotifications(agents);
  await loadMaps(agents);
})();
</script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</body>
</html>
