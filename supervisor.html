<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المشرف</title>
<style>
body { font-family: Arial; margin:0; padding:0; background:#e0f7fa; }
.container { max-width:1200px; margin:20px auto; padding:20px; }
h2 { text-align:center; color:#0277bd; }
section { margin-bottom:30px; padding:15px; background:#fff; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
table { width:100%; border-collapse: collapse; margin-top:10px; }
table, th, td { border:1px solid #ccc; }
th, td { padding:8px; text-align:center; }
input, select { padding:8px; margin:5px 0; border-radius:6px; border:1px solid #ccc; }
img { max-width:150px; max-height:150px; border-radius:6px; }
.map-container { height:300px; margin-bottom:20px; border:1px solid #ccc; border-radius:6px; }
.agent-map-title { font-weight:bold; margin-bottom:5px; }
</style>
</head>
<body>
<div class="container">
  <h2>لوحة المشرف</h2>

  <!-- اختيار المندوب -->
  <section>
    <h3>عرض بيانات المندوب</h3>
    <label>اختر المندوب:
      <select id="filterAgent">
        <option value="">الكل</option>
      </select>
    </label>
  </section>

  <!-- المهام -->
  <section>
    <h3>المهام</h3>
    <table>
      <thead id="tasksHeader"></thead>
      <tbody id="tasksTableBody"></tbody>
    </table>
  </section>

  <!-- التقارير -->
  <section>
    <h3>التقارير</h3>
    <table>
      <thead id="reportsHeader"></thead>
      <tbody id="reportsTableBody"></tbody>
    </table>
  </section>

  <!-- الإشعارات -->
  <section>
    <h3>الإشعارات</h3>
    <table>
      <thead id="notificationsHeader"></thead>
      <tbody id="notificationsTableBody"></tbody>
    </table>
  </section>

  <!-- الخرائط لكل مندوب -->
  <section>
    <h3>خرائط المندوبين</h3>
    <div id="mapsContainer"></div>
  </section>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabaseUrl = "https://vkativialsvvbifhjrey.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrYXRpdmlhbHN2dmJpZmhqcmV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMDMxMDUsImV4cCI6MjA3MzY3OTEwNX0.iC-gq-uuXnK_1cJ_gYcjig8sr-bQfhqPk0SnuqbAeL0";
const supabase = createClient(supabaseUrl, supabaseKey);

// تحميل المندوبين
async function loadAgents(){
  const { data: agents } = await supabase.from('users').select('*').eq('role','agent');
  const select = document.getElementById('filterAgent');
  agents.forEach(a=>{
    const opt = document.createElement('option');
    opt.value = a.id;
    opt.text = a.email || a.email_or_phone || a.id;
    select.appendChild(opt);
  });
}

// تحميل المهام ديناميكياً
async function loadTasks(agentId=null){
  let query = supabase.from('tasks').select('*');
  if(agentId) query = query.eq('assigned_to', agentId);
  const { data: tasks } = await query;

  const tbody = document.getElementById('tasksTableBody');
  const thead = document.getElementById('tasksHeader');
  tbody.innerHTML='';
  thead.innerHTML='';

  if(tasks.length){
    const headerRow = document.createElement('tr');
    Object.keys(tasks[0]).forEach(k=>{
      const th = document.createElement('th');
      th.textContent = k;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    tasks.forEach(t=>{
      const tr = document.createElement('tr');
      Object.keys(t).forEach(k=>{
        const td = document.createElement('td');
        td.textContent = t[k] || '-';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }
}

// تحميل التقارير ديناميكياً
async function loadReports(agentId=null){
  let query = supabase.from('reports').select('*');
  if(agentId) query = query.eq('agent_id', agentId);
  const { data: reports } = await query;

  const tbody = document.getElementById('reportsTableBody');
  const thead = document.getElementById('reportsHeader');
  tbody.innerHTML='';
  thead.innerHTML='';

  if(reports.length){
    const headerRow = document.createElement('tr');
    Object.keys(reports[0]).forEach(k=>{
      const th = document.createElement('th'); th.textContent = k;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    reports.forEach(r=>{
      const tr = document.createElement('tr');
      Object.keys(r).forEach(k=>{
        const td = document.createElement('td');
        td.textContent = r[k] || '-';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }
}

// تحميل الإشعارات ديناميكياً
async function loadNotifications(agentId=null){
  let query = supabase.from('notifications').select('*');
  if(agentId) query = query.eq('user_id', agentId);
  const { data: notifications } = await query;

  const tbody = document.getElementById('notificationsTableBody');
  const thead = document.getElementById('notificationsHeader');
  tbody.innerHTML='';
  thead.innerHTML='';

  if(notifications.length){
    const headerRow = document.createElement('tr');
    Object.keys(notifications[0]).forEach(k=>{
      const th = document.createElement('th'); th.textContent = k;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    notifications.forEach(n=>{
      const tr = document.createElement('tr');
      Object.keys(n).forEach(k=>{
        const td = document.createElement('td');
        td.textContent = n[k] || '-';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }
}

// تحميل الخرائط
async function loadMaps(){
  const { data: agents } = await supabase.from('users').select('*').eq('role','agent');
  const { data: tasks } = await supabase.from('tasks').select('*');
  const container = document.getElementById('mapsContainer');
  container.innerHTML='';

  agents.forEach(agent=>{
    const div = document.createElement('div');
    div.classList.add('map-container');

    const title = document.createElement('div');
    title.classList.add('agent-map-title');
    title.textContent = agent.email || agent.id;
    div.appendChild(title);

    const mapDiv = document.createElement('div');
    mapDiv.style.height='250px';
    div.appendChild(mapDiv);
    container.appendChild(div);

    // إيجاد أي أعمدة lat/lng
    const t = tasks.find(task => task.assigned_to===agent.id && (task.lat || task.latitude));
    if(t){
      const lat = t.lat || t.latitude;
      const lng = t.lng || t.longitude;
      if(lat && lng){
        import('https://unpkg.com/leaflet/dist/leaflet.js').then(L=>{
          const map = L.map(mapDiv).setView([lat,lng], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
          L.marker([lat,lng]).addTo(map);
        });
      }
    }
  });
}

// اختيار المندوب
document.getElementById('filterAgent').addEventListener('change', e=>{
  const agentId = e.target.value || null;
  loadTasks(agentId);
  loadReports(agentId);
  loadNotifications(agentId);
});

// تحميل البيانات عند البداية
loadAgents().then(()=>{
  loadTasks();
  loadReports();
  loadNotifications();
  loadMaps();
});
</script>
</body>
</html>
