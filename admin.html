<script>
document.getElementById('createUserForm').addEventListener('submit', async e => {
  e.preventDefault();
  const email = document.getElementById('newUserEmail').value.trim();
  const password = document.getElementById('newUserPassword').value;
  const role = document.getElementById('newUserRole').value;

  if (!email || !password || !role) return alert('Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');

  try {
    console.log("ğŸš€ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯:", { email, role });

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Supabase Auth
    const { data, error: signUpError } = await supabase.auth.signUp({ email, password });
    console.log("ğŸ“Œ Ù†ØªÙŠØ¬Ø© signUp:", { data, signUpError });

    if (signUpError) throw signUpError;

    const userId = data.user?.id;
    console.log("âœ… userId Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹:", userId);

    if (!userId) throw new Error('âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');

    // Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ÙÙŠ Ø¬Ø¯ÙˆÙ„ users
    const { data: insertData, error: insertError } = await supabase
      .from('users')
      .insert([{ id: userId, email, role }])
      .select();

    console.log("ğŸ“Œ Ù†ØªÙŠØ¬Ø© insert ÙÙŠ Ø¬Ø¯ÙˆÙ„ users:", { insertData, insertError });

    if (insertError) throw insertError;

    alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
    e.target.reset();
    await loadUsers();
    await loadAgents();
    await loadTasks();

  } catch (err) {
    console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', err);
    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + err.message);
  }
});
</script>
