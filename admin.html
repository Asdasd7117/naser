<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>لوحة المدير</title>
<style>
  body { font-family: Arial; margin:0; padding:0; background:#e0f7fa; }
  .container { max-width:1200px; margin:20px auto; padding:20px; }
  nav { display:flex; gap:10px; justify-content:center; margin-bottom:20px; flex-wrap: wrap; }
  nav button { padding:10px 20px; cursor:pointer; border:none; border-radius:8px; background:#4dd0e1; color:#000; }
  nav button.active { background:#0288d1; color:#fff; }
  section { display:none; background:#fff; padding:15px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin-bottom:20px; }
  section.active { display:block; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th,td { border:1px solid #ccc; padding:8px; text-align:center; }
  input, select, button, textarea { padding:8px; margin:5px 0; border-radius:6px; border:1px solid #ccc; width:100%; box-sizing:border-box; }
  button.primary { background:#0288d1; color:#fff; border:none; cursor:pointer; padding:10px 16px; }
  .row { display:flex; gap:10px; }
  .row > * { flex:1; }
  @media (max-width:800px){ .row{ flex-direction:column } }
</style>
</head>
<body>
<div class="container">
  <h2>لوحة المدير</h2>

  <nav>
    <button id="tasksTab" class="active">المهام</button>
    <button id="notificationsTab">الإشعارات</button>
    <button id="reportsTab">تقارير المندوبين</button>
    <button id="mapTab">خريطة العملاء</button>
    <button id="usersTab">حسابات المستخدمين</button>
  </nav>

  <!-- المهام -->
  <section id="tasksSection" class="active">
    <h3>إنشاء مهمة جديدة</h3>
    <form id="taskForm">
      <div class="row">
        <input type="text" id="clientName" placeholder="اسم العميل" required>
        <input type="text" id="clientAddress" placeholder="عنوان العميل" required>
      </div>
      <div class="row">
        <input type="time" id="visitTime" required>
        <select id="assignedTo" required><option value="">اختر مندوب</option></select>
      </div>
      <button type="submit" class="primary">حفظ المهمة</button>
    </form>

    <h4>المهام الحالية</h4>
    <table>
      <thead>
        <tr><th>العميل</th><th>العنوان</th><th>الوقت</th><th>المندوب</th><th>الحالة</th><th>حذف</th></tr>
      </thead>
      <tbody id="tasksTableBody"></tbody>
    </table>
  </section>

  <!-- الإشعارات -->
  <section id="notificationsSection">
    <h3>إرسال إشعار لمندوب محدد أو للجميع</h3>
    <select id="notifySelect"><option value="all">إلى الجميع</option></select>
    <textarea id="notificationMessage" placeholder="اكتب الرسالة هنا"></textarea>
    <button id="sendNotificationBtn" class="primary">إرسال الإشعار</button>
  </section>

  <!-- تقارير المندوبين -->
  <section id="reportsSection">
    <h3>تقارير المندوبين</h3>
    <table>
      <thead><tr><th>المندوب</th><th>العميل</th><th>التقرير</th><th>الصورة</th></tr></thead>
      <tbody id="reportsTableBody"></tbody>
    </table>
  </section>

  <!-- خريطة العملاء -->
  <section id="mapSection">
    <h3>خريطة المهام</h3>
    <div id="map" style="height:400px;background:#f3f3f3;display:flex;align-items:center;justify-content:center;color:#666;">
      (ضع هنا خريطة Leaflet لاحقاً)
    </div>
  </section>

  <!-- إدارة المستخدمين -->
  <section id="usersSection">
    <h3>إدارة حسابات المندوب والمشرف</h3>

    <form id="createUserForm">
      <div class="row">
        <input type="email" id="newUserEmail" placeholder="البريد الإلكتروني" required>
        <input type="password" id="newUserPassword" placeholder="كلمة المرور" required>
      </div>
      <select id="newUserRole" required>
        <option value="">اختر الدور</option>
        <option value="agent">مندوب</option>
        <option value="supervisor">مشرف</option>
      </select>
      <button type="submit" class="primary">إنشاء حساب</button>
    </form>

    <h4>المستخدمون الحاليون</h4>
    <table>
      <thead><tr><th>البريد الإلكتروني</th><th>الدور</th><th>حذف</th></tr></thead>
      <tbody id="usersTableBody"></tbody>
    </table>
  </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', async ()=>{

  const tabs = { tasks:'tasksSection', notifications:'notificationsSection', reports:'reportsSection', map:'mapSection', users:'usersSection' }
  Object.keys(tabs).forEach(key=>{
    document.getElementById(key+'Tab').addEventListener('click', ()=>{
      Object.values(tabs).forEach(s=>document.getElementById(s).classList.remove('active'))
      document.getElementById(tabs[key]).classList.add('active')
      Object.keys(tabs).forEach(k=>document.getElementById(k+'Tab').classList.remove('active'))
      document.getElementById(key+'Tab').classList.add('active')
    })
  })

  async function fetchAPI(endpoint, method='GET', body=null){
    const res = await fetch(`/api/${endpoint}`, {
      method,
      headers: {'Content-Type':'application/json'},
      body: body ? JSON.stringify(body) : null
    });
    return await res.json();
  }

  let agents = [];

  async function loadAgents(){
    const users = await fetchAPI('users');
    agents = users.filter(u=>u.role==='agent');
    const assignedTo = document.getElementById('assignedTo');
    const notifySelect = document.getElementById('notifySelect');
    assignedTo.innerHTML = '<option value="">اختر مندوب</option>';
    notifySelect.innerHTML = '<option value="all">إلى الجميع</option>';
    agents.forEach(a=>{
      const o1 = document.createElement('option'); o1.value = a.id; o1.textContent = a.email; assignedTo.appendChild(o1);
      const o2 = document.createElement('option'); o2.value = a.id; o2.textContent = a.email; notifySelect.appendChild(o2);
    });
  }

  async function loadTasks(){
    const tasks = await fetchAPI('tasks');
    const tbody = document.getElementById('tasksTableBody');
    tbody.innerHTML = '';
    tasks.forEach(t=>{
      const agent = agents.find(a=>a.id===t.assigned_to);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t.client_name}</td><td>${t.client_address}</td><td>${t.visit_time}</td><td>${agent?.email||'-'}</td><td>${t.status}</td><td><button data-id="${t.id}" class="deleteTaskBtn">حذف</button></td>`;
      tbody.appendChild(tr);
    });
  }

  document.getElementById('tasksTableBody').addEventListener('click', async e=>{
    if(e.target.classList.contains('deleteTaskBtn')){
      const id = e.target.dataset.id;
      if(confirm('هل تريد حذف هذه المهمة؟')){
        await fetchAPI(`tasks/${id}`,'DELETE');
        await loadTasks();
      }
    }
  });

  async function loadUsers(){
    const users = await fetchAPI('users');
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';
    users.forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${u.email}</td><td>${u.role}</td><td><button data-id="${u.id}" class="deleteUserBtn">حذف</button></td>`;
      tbody.appendChild(tr);
    });
  }

  document.getElementById('usersTableBody').addEventListener('click', async e=>{
    if(e.target.classList.contains('deleteUserBtn')){
      const id = e.target.dataset.id;
      if(confirm('هل تريد حذف هذا المستخدم؟')){
        await fetchAPI(`users/${id}`,'DELETE');
        await loadUsers();
        await loadAgents();
        await loadTasks();
      }
    }
  });

  document.getElementById('createUserForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const email = document.getElementById('newUserEmail').value;
    const password = document.getElementById('newUserPassword').value;
    const role = document.getElementById('newUserRole').value;
    const result = await fetchAPI('create-user','POST',{ email, password, role });
    if(result.success){
      alert('تم إنشاء الحساب');
      e.target.reset();
      await loadUsers();
      await loadAgents();
      await loadTasks();
    }else{
      alert('حدث خطأ: ' + result.message);
    }
  });

  await loadAgents();
  await loadTasks();
  await loadUsers();

});
</script>
</body>
</html>
