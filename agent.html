<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المندوب</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body { font-family: Arial; margin:0; padding:0; background:#e0f7fa; }
.container { max-width:1000px; margin:20px auto; padding:20px; }
h2 { text-align:center; color:#0277bd; }
nav { display:flex; gap:15px; justify-content:center; margin-bottom:20px; }
nav button { padding:10px 15px; border:none; border-radius:6px; background:#4dd0e1; cursor:pointer; }
nav button.active { background:#0288d1; color:#fff; }
section { display:none; margin-bottom:30px; padding:15px; background:#fff; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
section.active { display:block; }
table { width:100%; border-collapse: collapse; margin-top:10px; }
table, th, td { border:1px solid #ccc; }
th, td { padding:8px; text-align:center; }
select, textarea, input, button { padding:8px; margin:5px 0; border-radius:6px; border:1px solid #ccc; }
button { background:#0288d1; color:#fff; cursor:pointer; }
button:hover { background:#0277bd; }
#map { height:400px; width:100%; margin-top:15px; }
</style>
</head>
<body>
<div class="container">
  <h2>لوحة المندوب</h2>
  <nav>
    <button id="tasksTab" class="active">مهامي</button>
    <button id="notificationsTab">الإشعارات</button>
    <button id="reportTab">رفع تقرير</button>
    <button id="mapTab">خريطة المهام</button>
  </nav>

  <!-- المهام -->
  <section id="tasksSection" class="active">
    <h3>مهامي الحالية</h3>
    <table>
      <thead><tr><th>العميل</th><th>العنوان</th><th>الوقت</th><th>الحالة</th><th>تغيير الحالة</th></tr></thead>
      <tbody id="tasksTableBody"></tbody>
    </table>
  </section>

  <!-- الإشعارات -->
  <section id="notificationsSection">
    <h3>الإشعارات</h3>
    <ul id="notificationsList"></ul>
  </section>

  <!-- رفع تقرير -->
  <section id="reportSection">
    <h3>رفع تقرير المهمة</h3>
    <form id="reportForm">
      <select id="taskSelect" required></select>
      <textarea id="reportText" placeholder="اكتب تقريرك هنا..." required></textarea>
      <input type="file" id="reportImage" accept="image/*" required>
      <button type="submit">رفع التقرير</button>
    </form>
  </section>

  <!-- خريطة المهام -->
  <section id="mapSection">
    <h3>خريطة المهام</h3>
    <div id="map"></div>
  </section>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabaseUrl = "https://vkativialsvvbifhjrey.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrYXRpdmlhbHN2dmJpZmhqcmV5Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1ODEwMzEwNSwiZXhwIjoyMDczNjc5MTA1fQ.xUR96RId88zr0VhJNuxEy55FSKUFTRVqxJQMMHNkoMY"; // ⚠️ ضع هنا Anon Key فقط
const supabase = createClient(supabaseUrl, supabaseKey);

let agentId = null;

// التحقق من المستخدم الحالي
document.addEventListener('DOMContentLoaded', async () => {
  const { data: { user }, error } = await supabase.auth.getUser();
  if (error || !user) {
    alert("الرجاء تسجيل الدخول أولاً");
    window.location.href = "login.html";
    return;
  }
  agentId = user.id;
  loadTasks();
  loadNotifications();
  loadMap();
});

const tabs = { tasks:'tasksSection', notifications:'notificationsSection', report:'reportSection', map:'mapSection' };
Object.keys(tabs).forEach(key=>{
  document.getElementById(key+'Tab').addEventListener('click', ()=>{
    Object.values(tabs).forEach(s=>document.getElementById(s).classList.remove('active'));
    document.getElementById(tabs[key]).classList.add('active');
    Object.keys(tabs).forEach(k=>document.getElementById(k+'Tab').classList.remove('active'));
    document.getElementById(key+'Tab').classList.add('active');
    if(key==='map') loadMap();
  });
});

// تحميل المهام
async function loadTasks(){
  const { data: tasks, error } = await supabase
    .from('tasks')
    .select('*')
    .eq('assigned_to', agentId)
    .order('created_at',{ascending:false});
  if(error){ console.error(error); return; }

  const tbody = document.getElementById('tasksTableBody');
  tbody.innerHTML='';
  tasks.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${t.client_name || '-'}</td>
      <td>${t.client_address || '-'}</td>
      <td>${t.visit_time || '-'}</td>
      <td>${t.status || '-'}</td>
      <td>
        <select data-task-id="${t.id}" class="statusSelect">
          <option value="pending" ${t.status==='pending'?'selected':''}>قيد التنفيذ</option>
          <option value="completed" ${t.status==='completed'?'selected':''}>تم التنفيذ</option>
          <option value="delayed" ${t.status==='delayed'?'selected':''}>مؤجلة</option>
        </select>
      </td>`;
    tbody.appendChild(tr);
  });

  document.querySelectorAll('.statusSelect').forEach(sel=>{
    sel.addEventListener('change', async e=>{
      const taskId = e.target.getAttribute('data-task-id');
      const status = e.target.value;
      await supabase.from('tasks').update({status}).eq('id',taskId);
      loadTasks();
    });
  });

  // قائمة رفع التقرير
  const taskSelect = document.getElementById('taskSelect');
  taskSelect.innerHTML='';
  tasks.forEach(t=>{
    const opt = document.createElement('option');
    opt.value = t.id;
    opt.text = t.client_name || 'مهمة';
    taskSelect.appendChild(opt);
  });
}

// تحميل الإشعارات
async function loadNotifications(){
  const { data: notes, error } = await supabase
    .from('notifications')
    .select('*')
    .eq('user_id', agentId)
    .order('created_at',{ascending:false});
  if(error){ console.error(error); return; }

  const ul = document.getElementById('notificationsList');
  ul.innerHTML='';
  notes.forEach(n=>{
    const li = document.createElement('li');
    li.textContent = n.message || '-';
    ul.appendChild(li);
  });
}

// رفع تقرير
document.getElementById('reportForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const taskId = document.getElementById('taskSelect').value;
  const reportText = document.getElementById('reportText').value;
  const file = document.getElementById('reportImage').files[0];
  if(!file) return alert('اختر صورة');

  const fileExt = file.name.split('.').pop();
  const fileName = `reports/${taskId}_${Date.now()}.${fileExt}`;
  const { error: uploadError } = await supabase.storage.from('reports').upload(fileName, file);
  if(uploadError) return alert('خطأ رفع الصورة: '+uploadError.message);

  const imageUrl = `${supabaseUrl}/storage/v1/object/public/reports/${fileName}`;
  await supabase.from('reports').insert([{ task_id: taskId, agent_id: agentId, report_text: reportText, image_url: imageUrl }]);
  alert('تم رفع التقرير بنجاح');
  document.getElementById('reportForm').reset();
});

// الخريطة
let map;
async function loadMap(){
  if(!map){
    map = L.map('map').setView([30.0444,31.2357],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);
  }
  const { data: tasks, error } = await supabase
    .from('tasks')
    .select('*')
    .eq('assigned_to', agentId);
  if(error){ console.error(error); return; }

  map.eachLayer(l=>{ if(l instanceof L.Marker) map.removeLayer(l); });
  tasks.forEach(t=>{
    if(t.client_address){
      L.marker([30.0444,31.2357]).addTo(map).bindPopup(`${t.client_name || '-'}<br>${t.client_address || '-'}`);
    }
  });
}
</script>
</body>
</html>
