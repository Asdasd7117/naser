<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المندوب</title>
<style>
  body {
    font-family: "Cairo", Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f4f4f9;
    color: #333;
  }
  .container {
    max-width: 1100px;
    margin: 20px auto;
    padding: 20px;
  }
  h2 {
    text-align: center;
    color: #222;
    margin-bottom: 25px;
  }
  nav {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 25px;
  }
  nav button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    background: #e0e0e0;
    cursor: pointer;
    font-weight: bold;
    transition: 0.3s;
  }
  nav button.active {
    background: #2c6df2;
    color: #fff;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  }
  nav button:hover {
    background: #2c6df2;
    color: #fff;
  }
  section {
    display: none;
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 5px 18px rgba(0,0,0,0.1);
    margin-bottom: 25px;
  }
  section.active {
    display: block;
  }
  h3 {
    margin-bottom: 15px;
    color: #2c6df2;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 15px;
  }
  table, th, td {
    border: 1px solid #ddd;
  }
  th {
    background: #f0f0f0;
    font-weight: bold;
  }
  th, td {
    padding: 10px;
    text-align: center;
  }
  select, textarea, input[type="file"], button {
    padding: 10px;
    margin: 7px 0;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
  }
  textarea {
    width: 100%;
    min-height: 100px;
    resize: vertical;
  }
  button {
    background: #2c6df2;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    border: none;
    transition: 0.3s;
  }
  button:hover {
    background: #1d4ecb;
  }
  ul {
    list-style: none;
    padding: 0;
  }
  ul li {
    background: #f9f9f9;
    margin-bottom: 10px;
    padding: 12px;
    border-radius: 6px;
    border: 1px solid #ddd;
  }
</style>
</head>
<body>
<div class="container">
  <h2>لوحة المندوب</h2>

  <nav>
    <button id="tasksTab" class="active">مهامي</button>
    <button id="notificationsTab">الإشعارات</button>
    <button id="reportTab">رفع تقرير</button>
  </nav>

  <!-- المهام -->
  <section id="tasksSection" class="active">
    <h3>مهامي الحالية</h3>
    <table>
      <thead>
        <tr><th>العميل</th><th>العنوان</th><th>الوقت</th><th>الحالة</th><th>تغيير الحالة</th></tr>
      </thead>
      <tbody id="tasksTableBody"></tbody>
    </table>
  </section>

  <!-- الإشعارات -->
  <section id="notificationsSection">
    <h3>الإشعارات</h3>
    <ul id="notificationsList"></ul>
  </section>

  <!-- رفع تقرير -->
  <section id="reportSection">
    <h3>رفع تقرير المهمة</h3>
    <form id="reportForm">
      <select id="taskSelect" required></select>
      <textarea id="reportText" placeholder="اكتب تقريرك هنا..." required></textarea>
      <input type="file" id="reportImage" accept="image/*" required>
      <button type="submit">رفع التقرير</button>
    </form>
  </section>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabaseUrl = "https://vkativialsvvbifhjrey.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrYXRpdmlhbHN2dmJpZmhqcmV5Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1ODEwMzEwNSwiZXhwIjoyMDczNjc5MTA1fQ.xUR96RId88zr0VhJNuxEy55FSKUFTRVqxJQMMHNkoMY"; // ⚠️ ضع هنا Anon Key فقط
const supabase = createClient(supabaseUrl, supabaseKey);

let agentId = null;

// التحقق من المستخدم الحالي
document.addEventListener('DOMContentLoaded', async () => {
  const { data: { user }, error } = await supabase.auth.getUser();
  if (error || !user) {
    alert("الرجاء تسجيل الدخول أولاً");
    window.location.href = "login.html";
    return;
  }
  agentId = user.id;
  loadTasks();
  loadNotifications();
});

const tabs = { tasks:'tasksSection', notifications:'notificationsSection', report:'reportSection' };
Object.keys(tabs).forEach(key=>{
  document.getElementById(key+'Tab').addEventListener('click', ()=>{
    Object.values(tabs).forEach(s=>document.getElementById(s).classList.remove('active'));
    document.getElementById(tabs[key]).classList.add('active');
    Object.keys(tabs).forEach(k=>document.getElementById(k+'Tab').classList.remove('active'));
    document.getElementById(key+'Tab').classList.add('active');
  });
});

// تحميل المهام
async function loadTasks(){
  const { data: tasks, error } = await supabase
    .from('tasks')
    .select('*')
    .eq('assigned_to', agentId)
    .order('created_at',{ascending:false});
  if(error){ console.error(error); return; }

  const tbody = document.getElementById('tasksTableBody');
  tbody.innerHTML='';
  tasks.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${t.client_name || '-'}</td>
      <td>${t.client_address || '-'}</td>
      <td>${t.visit_time || '-'}</td>
      <td>${t.status || '-'}</td>
      <td>
        <select data-task-id="${t.id}" class="statusSelect">
          <option value="pending" ${t.status==='pending'?'selected':''}>قيد التنفيذ</option>
          <option value="completed" ${t.status==='completed'?'selected':''}>تم التنفيذ</option>
          <option value="delayed" ${t.status==='delayed'?'selected':''}>مؤجلة</option>
        </select>
      </td>`;
    tbody.appendChild(tr);
  });

  document.querySelectorAll('.statusSelect').forEach(sel=>{
    sel.addEventListener('change', async e=>{
      const taskId = e.target.getAttribute('data-task-id');
      const status = e.target.value;
      await supabase.from('tasks').update({status}).eq('id',taskId);
      loadTasks();
    });
  });

  // قائمة رفع التقرير
  const taskSelect = document.getElementById('taskSelect');
  taskSelect.innerHTML='';
  tasks.forEach(t=>{
    const opt = document.createElement('option');
    opt.value = t.id;
    opt.text = t.client_name || 'مهمة';
    taskSelect.appendChild(opt);
  });
}

// تحميل الإشعارات
async function loadNotifications(){
  const { data: notes, error } = await supabase
    .from('notifications')
    .select('*')
    .eq('user_id', agentId)
    .order('created_at',{ascending:false});
  if(error){ console.error(error); return; }

  const ul = document.getElementById('notificationsList');
  ul.innerHTML='';
  notes.forEach(n=>{
    const li = document.createElement('li');
    li.textContent = n.message || '-';
    ul.appendChild(li);
  });
}

// رفع تقرير
document.getElementById('reportForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const taskId = document.getElementById('taskSelect').value;
  const reportText = document.getElementById('reportText').value;
  const file = document.getElementById('reportImage').files[0];
  if(!file) return alert('اختر صورة');

  const fileExt = file.name.split('.').pop();
  const fileName = `reports/${taskId}_${Date.now()}.${fileExt}`;
  const { error: uploadError } = await supabase.storage.from('reports').upload(fileName, file);
  if(uploadError) return alert('خطأ رفع الصورة: '+uploadError.message);

  const imageUrl = `${supabaseUrl}/storage/v1/object/public/reports/${fileName}`;
  await supabase.from('reports').insert([{ task_id: taskId, agent_id: agentId, report_text: reportText, image_url: imageUrl }]);
  alert('تم رفع التقرير بنجاح');
  document.getElementById('reportForm').reset();
});
</script>
</body>
</html>
