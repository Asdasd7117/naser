<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة المندوب</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f7fa; color:#333; }
    .container { max-width:1000px; margin:20px auto; padding:15px; }
    h2 { text-align:center; color:#0288d1; }
    section { display:none; padding:15px; background:#fff; border-radius:12px; margin-bottom:15px; box-shadow:0 3px 10px rgba(0,0,0,0.1);}
    section.active { display:block; }
    .cards { display:flex; flex-wrap:wrap; gap:10px; overflow-x:auto;}
    .card { flex:1 1 220px; background:#e1f5fe; padding:10px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    .card.green { background:#c8e6c9;}
    .card.yellow { background:#fff9c4;}
    .card.red { background:#ffcdd2;}
    button { padding:8px 12px; background:#0288d1; color:#fff; border:none; border-radius:6px; cursor:pointer; margin-top:5px;}
    button:hover { background:#0277bd;}
    textarea { width:100%; height:80px; padding:8px; margin-top:5px; border-radius:6px; border:1px solid #ccc;}
    input[type="file"] { margin-top:5px; }
    #signatureCanvas { border:1px solid #ccc; border-radius:6px; width:100%; height:150px; touch-action:none;}
    .bottomNav { display:flex; justify-content:space-around; position:fixed; bottom:0; width:100%; background:#0288d1; padding:10px 0;}
    .bottomNav button { background:transparent; color:#fff; border:none; font-size:16px; }
    .bottomNav button.active { font-weight:bold; text-decoration:underline;}
    #map { width:100%; height:300px; border-radius:10px; margin-top:10px;}
    #notificationsContainer { max-height:300px; overflow-y:auto; }
    .notification { padding:10px; margin-bottom:5px; border-radius:6px; background:#fff; box-shadow:0 1px 5px rgba(0,0,0,0.1);}
    .notification.unread { color:red; font-weight:bold; }
  </style>
</head>
<body>
  <div class="container">
    <h2>لوحة المندوب</h2>

    <!-- المهام -->
    <section id="tasksSection" class="active">
      <h3>المهام اليومية</h3>
      <div class="cards" id="tasksContainer"></div>
    </section>

    <!-- التقارير -->
    <section id="reportSection">
      <h3>رفع التقرير</h3>
      <label>اختر المهمة:
        <select id="selectTask"><option value="">اختر مهمة</option></select>
      </label>
      <label>الملاحظات:</label>
      <textarea id="taskNotes" placeholder="أدخل الملاحظات هنا"></textarea>
      <label>إضافة صورة/صور:</label>
      <input type="file" id="taskImages" accept="image/*" multiple>
      <label>توقيع العميل:</label>
      <canvas id="signatureCanvas"></canvas>
      <button id="clearSignatureBtn">مسح التوقيع</button>
      <button id="submitReport">إرسال التقرير</button>
    </section>

    <!-- الخريطة -->
    <section id="mapSection">
      <h3>الموقع الحالي</h3>
      <div id="map"></div>
      <button id="refreshLocation">تحديث الموقع</button>
    </section>

    <!-- الإشعارات -->
    <section id="notificationsSection">
      <h3>الإشعارات</h3>
      <div id="notificationsContainer"></div>
    </section>
  </div>

  <!-- التنقل -->
  <div class="bottomNav">
    <button id="tasksBtn" class="active">المهام</button>
    <button id="reportBtn">التقارير</button>
    <button id="mapBtn">الخريطة</button>
    <button id="notificationsBtn">الإشعارات</button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = "https://vkativialsvvbifhjrey.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrYXRpdmlhbHN2dmJpZmhqcmV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMDMxMDUsImV4cCI6MjA3MzY3OTEwNX0.iC-gq-uuXnK_1cJ_gYcjig8sr-bQfhqPk0SnuqbAeL0";
    const supabase = createClient(supabaseUrl, supabaseKey);

    // تسجيل المستخدم الحالي
    let currentUserId = null;
    (async ()=>{
      const { data: { session } } = await supabase.auth.getSession();
      if(!session || !session.user){
        alert("لم يتم تسجيل الدخول!");
        window.location.href="login.html";
        return;
      }
      currentUserId = session.user.id;
      loadTasks();
      loadNotifications();
    })();

    // --- التنقل بين الأقسام ---
    const sections = {
      tasks: document.getElementById("tasksSection"),
      report: document.getElementById("reportSection"),
      map: document.getElementById("mapSection"),
      notifications: document.getElementById("notificationsSection")
    };
    const navButtons = {
      tasks: document.getElementById("tasksBtn"),
      report: document.getElementById("reportBtn"),
      map: document.getElementById("mapBtn"),
      notifications: document.getElementById("notificationsBtn")
    };
    Object.keys(navButtons).forEach(key=>{
      navButtons[key].addEventListener("click", ()=>{
        Object.keys(sections).forEach(k=>sections[k].classList.remove("active"));
        sections[key].classList.add("active");
        Object.keys(navButtons).forEach(k=>navButtons[k].classList.remove("active"));
        navButtons[key].classList.add("active");
      });
    });

    // --- تحميل المهام ---
    async function loadTasks(){
      if(!currentUserId) return;
      const { data: tasks, error } = await supabase.from("tasks").select("*").eq("assigned_to", currentUserId);
      if(error){ console.error(error); return; }
      const container = document.getElementById("tasksContainer");
      const selectTask = document.getElementById("selectTask");
      container.innerHTML = "";
      selectTask.innerHTML = "<option value=''>اختر مهمة</option>";
      tasks.forEach(t=>{
        const card = document.createElement("div");
        card.className="card";
        if(t.status==="completed") card.classList.add("green");
        else if(t.status==="pending") card.classList.add("yellow");
        else if(t.status==="delayed") card.classList.add("red");
        card.innerHTML = `<strong>${t.client_name}</strong><br>العنوان: ${t.client_address || ""}<br>الحالة: ${t.status}`;
        container.appendChild(card);

        const opt = document.createElement("option");
        opt.value = t.id;
        opt.text = t.client_name;
        selectTask.appendChild(opt);
      });
    }

    // --- رفع التقرير ---
    const canvas = document.getElementById("signatureCanvas");
    const ctx = canvas.getContext("2d");
    let drawing=false;
    canvas.addEventListener("pointerdown", e=>{drawing=true; ctx.moveTo(e.offsetX,e.offsetY)});
    canvas.addEventListener("pointermove", e=>{ if(drawing){ ctx.lineTo(e.offsetX,e.offsetY); ctx.stroke(); } });
    canvas.addEventListener("pointerup", ()=>drawing=false);
    document.getElementById("clearSignatureBtn").addEventListener("click", ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height) });

    document.getElementById("submitReport").addEventListener("click", async ()=>{
      const taskId = document.getElementById("selectTask").value;
      const notes = document.getElementById("taskNotes").value;
      if(!taskId) return alert("اختر المهمة");
      const signatureData = canvas.toDataURL();
      await supabase.from("tasks").update({ notes, signature: signatureData, status:"completed" }).eq("id", taskId);
      alert("تم إرسال التقرير");
      document.getElementById("taskNotes").value="";
      ctx.clearRect(0,0,canvas.width,canvas.height);
      loadTasks();
    });

    // --- الخريطة ---
    let map, marker;
    function initMap(){
      map = L.map("map").setView([30.0444,31.2357],13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap"}).addTo(map);
      marker = L.marker([30.0444,31.2357]).addTo(map).bindPopup("موقعك الحالي");
    }
    document.getElementById("refreshLocation").addEventListener("click", ()=>{
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          marker.setLatLng([lat,lng]);
          map.setView([lat,lng],13);
          supabase.from("users").update({ lat, lng }).eq("id", currentUserId);
        });
      }else alert("لا يمكن الوصول للموقع");
    });

    // --- الإشعارات ---
    async function loadNotifications(){
      if(!currentUserId) return;
      const { data: notes, error } = await supabase.from("notifications").select("*").eq("user_id", currentUserId).order("created_at",{ascending:false});
      if(error){ console.error(error); return; }
      const container = document.getElementById("notificationsContainer");
      container.innerHTML="";
      notes.forEach(n=>{
        const div=document.createElement("div");
        div.className="notification";
        if(!n.read) div.classList.add("unread");
        div.textContent=n.message;
        container.appendChild(div);
      });
    }

    // --- التحديث اللحظي ---
    supabase.channel("realtime")
      .on("postgres_changes",{event:"*",schema:"public",table:"tasks"},loadTasks)
      .on("postgres_changes",{event:"*",schema:"public",table:"notifications"},loadNotifications)
      .subscribe();

    // --- تشغيل أولي ---
    initMap();
  </script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</body>
</html>
