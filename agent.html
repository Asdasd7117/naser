<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المندوب</title>
<link rel="stylesheet" href="style.css">
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#e0f7fa;}
.container { max-width:1000px; margin:20px auto; padding:15px;}
h2 { text-align:center; color:#0277bd; }
section { display:none; padding:15px; background:#fff; border-radius:12px; margin-bottom:15px; box-shadow:0 3px 10px rgba(0,0,0,0.1);}
section.active { display:block; }
.cards { display:flex; flex-wrap:wrap; gap:10px; overflow-x:auto;}
.card { flex:1 1 200px; background:#b3e5fc; padding:10px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.card.green { background:#c8e6c9;}
.card.yellow { background:#fff9c4;}
.card.red { background:#ffcdd2;}
button { padding:8px 12px; background:#0288d1; color:#fff; border:none; border-radius:6px; cursor:pointer; margin-top:5px;}
button:hover { background:#0277bd;}
textarea { width:100%; height:80px; padding:8px; margin-top:5px; border-radius:6px; border:1px solid #ccc;}
input[type="file"] { margin-top:5px; }
#signatureCanvas { border:1px solid #ccc; border-radius:6px; width:100%; height:150px; touch-action: none;}
.bottomNav { display:flex; justify-content:space-around; position:fixed; bottom:0; width:100%; background:#4dd0e1; padding:10px 0;}
.bottomNav button { background:transparent; color:#fff; border:none; font-size:16px; }
.bottomNav button.active { font-weight:bold; text-decoration:underline;}
#map { width:100%; height:300px; border-radius:10px;}
#notificationsContainer { max-height:300px; overflow-y:auto; }
.notification { padding:10px; margin-bottom:5px; border-radius:6px; background:#fff; box-shadow:0 1px 5px rgba(0,0,0,0.1);}
.notification.unread { color:red; font-weight:bold; }
</style>
</head>
<body>
<div class="container">
  <h2>لوحة المندوب</h2>

  <!-- مهام يومية -->
  <section id="tasksSection" class="active">
    <h3>المهام اليومية</h3>
    <div class="cards" id="tasksContainer">
      <!-- بطاقات المهام -->
    </div>
  </section>

  <!-- رفع التقرير -->
  <section id="reportSection">
    <h3>رفع التقرير</h3>
    <label>اختر المهمة:
      <select id="selectTask"><option value="">اختر مهمة</option></select>
    </label>
    <label>الملاحظات:</label>
    <textarea id="taskNotes" placeholder="أدخل الملاحظات هنا"></textarea>
    <label>إضافة صورة/صور:</label>
    <input type="file" id="taskImages" accept="image/*" multiple>
    <label>توقيع العميل:</label>
    <canvas id="signatureCanvas"></canvas>
    <button id="clearSignatureBtn">مسح التوقيع</button>
    <button id="submitReport">إرسال التقرير</button>
  </section>

  <!-- الخريطة -->
  <section id="mapSection">
    <h3>الموقع الحالي</h3>
    <div id="map"></div>
    <button id="refreshLocation">تحديث الموقع</button>
  </section>

  <!-- الإشعارات -->
  <section id="notificationsSection">
    <h3>الإشعارات</h3>
    <div id="notificationsContainer"></div>
  </section>
</div>

<!-- التنقل الأسفل -->
<div class="bottomNav">
  <button id="tasksBtn" class="active">المهام</button>
  <button id="reportBtn">التقارير</button>
  <button id="mapBtn">الخريطة</button>
  <button id="notificationsBtn">الإشعارات</button>
</div>

<script type="module">
import { supabase, currentUser, subscribeTable } from './main.js';

const user = currentUser();

// --- التنقل بين الأقسام ---
const sections = {
  tasks: document.getElementById('tasksSection'),
  report: document.getElementById('reportSection'),
  map: document.getElementById('mapSection'),
  notifications: document.getElementById('notificationsSection')
}
const navButtons = {
  tasks: document.getElementById('tasksBtn'),
  report: document.getElementById('reportBtn'),
  map: document.getElementById('mapBtn'),
  notifications: document.getElementById('notificationsBtn')
}

Object.keys(navButtons).forEach(key=>{
  navButtons[key].addEventListener('click',()=>{
    Object.keys(sections).forEach(k=>sections[k].classList.remove('active'))
    sections[key].classList.add('active')
    Object.keys(navButtons).forEach(k=>navButtons[k].classList.remove('active'))
    navButtons[key].classList.add('active')
  })
})

// --- المهام اليومية ---
async function loadTasks(){
  const { data: tasks } = await supabase.from('tasks').select('*').eq('assigned_to', user.id)
  const container = document.getElementById('tasksContainer')
  const selectTask = document.getElementById('selectTask')
  container.innerHTML = ''; selectTask.innerHTML='<option value="">اختر مهمة</option>'
  tasks.forEach(t=>{
    const card = document.createElement('div')
    card.className='card'
    if(t.status==='completed') card.classList.add('green')
    else if(t.status==='pending') card.classList.add('yellow')
    else if(t.status==='delayed') card.classList.add('red')

    card.innerHTML = `
      <strong>${t.client_name}</strong><br>
      ${t.client_address}<br>
      وقت الزيارة: ${t.visit_time}<br>
      الحالة: ${t.status}<br>
      <button class="updateStatusBtn" data-id="${t.id}">تغيير الحالة</button>
    `
    container.appendChild(card)
    const opt = document.createElement('option'); opt.value=t.id; opt.text=t.client_name; selectTask.appendChild(opt)
  })
}

// تحديث حالة المهمة
document.addEventListener('click', async e=>{
  if(e.target.classList.contains('updateStatusBtn')){
    const taskId = e.target.dataset.id
    const newStatus = prompt('أدخل الحالة الجديدة (pending / completed / delayed):')
    if(!['pending','completed','delayed'].includes(newStatus)) return alert('حالة غير صحيحة')
    await supabase.from('tasks').update({status:newStatus}).eq('id',taskId)
  }
})

// --- رفع التقرير ---
const canvas = document.getElementById('signatureCanvas')
const ctx = canvas.getContext('2d')
let drawing = false

canvas.addEventListener('pointerdown', e=>{ drawing=true; ctx.moveTo(e.offsetX,e.offsetY) })
canvas.addEventListener('pointermove', e=>{ if(drawing){ ctx.lineTo(e.offsetX,e.offsetY); ctx.stroke() } })
canvas.addEventListener('pointerup', ()=>drawing=false)
document.getElementById('clearSignatureBtn').addEventListener('click', ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height) })

document.getElementById('submitReport').addEventListener('click', async ()=>{
  const taskId = document.getElementById('selectTask').value
  const notes = document.getElementById('taskNotes').value
  if(!taskId) return alert('اختر المهمة')
  // حفظ النصوص والتوقيع (يمكنك رفع الصور للتخزين لاحقاً)
  const signatureData = canvas.toDataURL()
  await supabase.from('tasks').update({ notes, signature: signatureData, status:'completed' }).eq('id',taskId)
  alert('تم إرسال التقرير بنجاح')
  document.getElementById('taskNotes').value=''
  ctx.clearRect(0,0,canvas.width,canvas.height)
})

// --- الخريطة ---
let map, marker
function initMap(){
  map = L.map('map').setView([24.7136,46.6753], 13) // الرياض
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap' }).addTo(map)
  marker = L.marker([24.7136,46.6753]).addTo(map).bindPopup('موقعك الحالي')
}
document.getElementById('refreshLocation').addEventListener('click', ()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude
      const lng = pos.coords.longitude
      marker.setLatLng([lat,lng])
      map.setView([lat,lng],13)
    })
  }else alert('لا يمكن الوصول إلى الموقع')
})

// --- الإشعارات ---
async function loadNotifications(){
  const { data } = await supabase.from('notifications').select('*').eq('user_id',user.id).order('created_at',{ascending:false})
  const container = document.getElementById('notificationsContainer')
  container.innerHTML=''
  data.forEach(n=>{
    const div = document.createElement('div')
    div.className='notification'
    if(!n.read) div.classList.add('unread')
    div.textContent = n.message
    container.appendChild(div)
  })
}

// --- التحديث اللحظي ---
subscribeTable('tasks', loadTasks)
subscribeTable('notifications', loadNotifications)

loadTasks()
loadNotifications()
initMap()
</script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</body>
</html>
