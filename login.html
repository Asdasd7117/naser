<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>تسجيل الدخول / إنشاء حساب</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; display:flex; justify-content:center; align-items:center; height:100vh; }
    .container { background:white; padding:20px; border-radius:10px; width:300px; text-align:center; box-shadow:0 0 10px rgba(0,0,0,0.2); }
    input, select { width:100%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:5px; }
    button { width:100%; padding:10px; background:#007bff; color:white; border:none; border-radius:5px; cursor:pointer; }
    button:hover { background:#0056b3; }
    .toggle { color:#007bff; cursor:pointer; margin-top:10px; display:block; }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="formTitle">تسجيل الدخول</h2>
    
    <form id="loginForm">
      <input type="text" id="email" placeholder="البريد الإلكتروني" required>
      <input type="password" id="password" placeholder="كلمة المرور" required>
      <button type="submit">تسجيل الدخول</button>
    </form>

    <form id="signupForm" style="display:none;">
      <input type="text" id="signupEmail" placeholder="البريد الإلكتروني" required>
      <input type="password" id="signupPassword" placeholder="كلمة المرور" required>
      <select id="role" required>
        <option value="agent">مندوب</option>
        <option value="supervisor">مشرف</option>
        <option value="admin">مدير</option>
      </select>
      <button type="submit">إنشاء حساب</button>
    </form>

    <span class="toggle" id="toggleForm">ليس لديك حساب؟ أنشئ واحدًا</span>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // ✅ بيانات Supabase
    const SUPABASE_URL = "https://ncjxqfwsswwikedaffif.supabase.co"
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5janhxZnF3c3d3aWtlZGFmZmlmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTcwNzAwODI2MSwiZXhwIjoyMDIyNTg0MjYxfQ.XXXX"

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

    // 🔄 تبديل بين تسجيل الدخول وإنشاء الحساب
    const toggle = document.getElementById("toggleForm")
    const loginForm = document.getElementById("loginForm")
    const signupForm = document.getElementById("signupForm")
    const formTitle = document.getElementById("formTitle")

    toggle.addEventListener("click", () => {
      if (loginForm.style.display === "none") {
        loginForm.style.display = "block"
        signupForm.style.display = "none"
        formTitle.textContent = "تسجيل الدخول"
        toggle.textContent = "ليس لديك حساب؟ أنشئ واحدًا"
      } else {
        loginForm.style.display = "none"
        signupForm.style.display = "block"
        formTitle.textContent = "إنشاء حساب"
        toggle.textContent = "لديك حساب؟ سجل الدخول"
      }
    })

    // ✅ تسجيل الدخول
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault()
      const email = document.getElementById("email").value
      const password = document.getElementById("password").value

      const { data, error } = await supabase
        .from("users")
        .select("id, role")
        .eq("email_or_phone", email)
        .eq("password", password)
        .single()

      if (error || !data) {
        alert("❌ خطأ في تسجيل الدخول")
        return
      }

      // 🟢 حفظ البيانات
      localStorage.setItem("agentId", data.id)
      localStorage.setItem("role", data.role)

      alert("✅ تم تسجيل الدخول بنجاح")
      window.location.href = "dashboard.html"
    })

    // ✅ إنشاء حساب جديد
    signupForm.addEventListener("submit", async (e) => {
      e.preventDefault()
      const email = document.getElementById("signupEmail").value
      const password = document.getElementById("signupPassword").value
      const role = document.getElementById("role").value

      const { data, error } = await supabase
        .from("users")
        .insert([{ email_or_phone: email, password, role }])
        .select("id, role")
        .single()

      if (error) {
        alert("❌ لم يتم إنشاء الحساب: " + error.message)
        return
      }

      // 🟢 حفظ البيانات
      localStorage.setItem("agentId", data.id)
      localStorage.setItem("role", data.role)

      alert("✅ تم إنشاء الحساب بنجاح")
      window.location.href = "dashboard.html"
    })
  </script>
</body>
</html>
